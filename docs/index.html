

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pyramid Game</title>
  <link rel="shortcut icon" type="image/x-icon" href="./logo.svg" id="favicon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="Pyramid Game is a zero-sum wealth redistribution game that uses cutting-edge pyramid scheme technology. It is not a financial security.">
  <meta name="keywords" content="pyramid game, pyramidgame, pyramidgame.eth, pyramid, game, scheme, pyramid scheme, steviep, steve pikelny, pikelny, crypto, ethereum, eth, bitcoin, scam, scam art, blockchain, onchain art, art">

  <meta name="twitter:image" content="https://pyramidgame.eth.limo/thumbnail.png">
  <meta name="twitter:image:alt" content="$ -> ▲">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@steviepxyz">
  <meta name="twitter:site" content="@steviepxyz">
  <meta property="twitter:description" content="Pyramid Game is a zero-sum wealth redistribution game that uses cutting-edge pyramid scheme technology. It is not a financial security.">

  <meta name="og:image" property="og:image" content="https://pyramidgame.eth.limo/thumbnail.png">
  <meta name="og:image:alt" content="$ -> ▲">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://pyramidgame.eth.limo">
  <meta property="og:title" content="Pyramid Game">
  <meta property="og:site_name" content="Pyramid Game">
  <meta property="og:description" content="Pyramid Game is a zero-sum wealth redistribution game that uses cutting-edge pyramid scheme technology. It is not a financial security.">


  <link rel="stylesheet" type="text/css" href="./styles.css">

  <style type="text/css">

    h1 {
      font-size: min(5em, 13vw);
      font-weight: 500;
    }

    h1, h2, h3 {
      text-align: center;
    }

    #docs h2, #docs h3, #docs h4, #docs h5 {
      text-align: left;
      margin-top: 1em;
    }

    .slowBlink {
      animation: Blink 3s steps(2, start) infinite;
    }

    .mediumBlink {
      animation: Blink 1.5s steps(3, start) infinite;
    }

    #logo {
      width: 500px;
      max-width: 81vw;
    }

    button {
      background: var(--gray-color);
      color: var(--font-color);
      border: 0.15em solid var(--font-color);
      padding: 0.5em 1em;
      font-size: 2em;
      font-weight: 500;
      letter-spacing: 0.1em;
    }

    button:hover {
      color: var(--bg-color);
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    button:active {
      color: var(--font-color);
      border-color: var(--font-color);
      background: var(--bg-color);
    }

    .connectButton:hover {
      border-color: var(--font-color);
    }

    .center-v {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .center {
      display: flex;
      justify-content: center;
    }

    table {
      border: 2px solid;
      border-spacing: 0;
    }

    td, th {
      border: 1px solid;
      padding: 0.5em;
    }

    th {
      font-weight: 600;
    }

    section {
      margin: 2.5em auto;
      padding: 0 0.75em;
    }

    nav {
      background: var(--font-color);
      color: var(--bg-color);
      padding: 0.5em;
      display: flex;
      justify-content: space-evenly;
      font-size: 1.5em;
    }

    nav a {
      color: var(--bg-color);
      display: inline-block;
      padding: 0.25em;
    }
    nav a:hover {
      color: var(--font-color);
      background: var(--bg-color);
      text-decoration: none;
    }

    @media(max-width: 740px) {
      nav {
        flex-direction: column;

      }
      nav > * {
        padding: 0.25em 0;
      }
      nav > a + a {
        border-top: 1px solid var(--bg-color);
      }
    }

    ul, .listLike {
      font-weight: bolder;
      list-style: none;
      padding: 0;
      margin-left: 1.5em;
      font-size: 1em;

    }

    ul li, .listLike > div {
      padding: 0.75em 0;
    }

    ul li::before {
      content: "▲";
      color: var(--font-color);
      display: inline-block;
      width: 1em;
      margin-left: -1em;
    }

    input {
      border: 3px solid var(--font-color);
      text-align: center;
      padding: 0.25em 0;
      font-size: 1.25em;
      background: var(--input-color);
    }

    input:active, input:focus, input:hover {
      outline: none;
      border-color: var(--accent-color);
    }

    input + .small-button {
      border-left: 0;
    }

    .small-button {
      font-size: 1.25em;
    }

    .tiny-button {
      font-size: 1em;
      margin-top: 0.25em;
    }
    .tiny-input {
      font-size: 1em;
      padding: 0.25em;
    }

    sup a {
      display: inline-block;
      border: 1px solid;
      text-decoration: none;
      color: var(--accent-color);
      padding: 0 0.25em;
      transform: translateY(-0.25em);
      margin-left: 0.25em;
      font-size: 0.75em;
    }

    sup a:hover {
      background: var(--accent-color);
      color: var(--accent-color);
      border-color: var(--accent-color);

      text-decoration: none;
    }

    a {
      text-decoration: none;
      color: var(--font-color);
    }

    a:hover {
      text-decoration: underline;
    }

    .invert {
      background: var(--font-color);
      color: var(--bg-color);
    }
    .invert a {
      color: var(--bg-color);
    }

    .scanlink-style {
      border-bottom: 0.1em solid rgba(0, 0, 0, 0);
      font-size: 1.75em;
    }

    .scanlink-style:hover {
      text-decoration: none;
      border-bottom: 0.1em solid;
    }

    .a-normal {
      text-decoration: underline;
    }
    .a-normal:hover {
      text-decoration: none;

    }

    .largeText {
      font-size: 6em;
    }
    @media (max-width:  640px) {
      .scanlink-style {
        font-size: 1.25em;
      }

    }

    @media (max-width:  550px) {
      .largeText {
        font-size: 3em;
      }

    }

    @media (max-width: 450px) {
      .scanlink-style {
        font-size: 0.9em;
      }
    }

    .contribution-row {
      border: 2px solid var(--font-color);
      padding: 1em;
      margin-bottom: 0.5em;
      line-height: 1.5;
      display: block;
      text-decoration: none;
      color: var(--font-color);
    }

    .contribution-row:hover {
      background: var(--font-color);
      color: var(--bg-color);
    }

    .contribution-row:hover .address {
      color: var(--bg-color);
    }

    .contribution-amount {
      font-weight: 600;
    }

    /* Small Leaders Grid */
    .small-leaders-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5em;
      max-width: 500px;
      width: 90vw;
      margin: 1em auto;
    }

    .small-leaders-grid leader-svg {
      width: 100%;
      max-width: 150px;
      margin: 0 auto;
      display: block;
    }

    leader-svg {
      border: 1px solid var(--dark-border-color);
    }

    .small-leaders-grid .bordered {
      border: 1px solid var(--font-color);
    }

    @media (max-width: 580px) {
      .small-leaders-grid {
        grid-template-columns: repeat(3, 1fr);
        max-width: 400px;
      }
    }

    @media (max-width: 400px) {
      .small-leaders-grid {
        gap: 0.3em;
        max-width: 95vw;
      }
    }

    /* Grid Leaderboard Styles */
    .leaderboard-grid {
/*      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0em;*/
      max-width: 1200px;
      margin: 2em auto;
      padding: 0 1em;
    }

    @media (max-width: 1110px) {
      .leaderboard-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 740px) {
      .leaderboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Address display toggle */
    .addr-short {
      display: inline;
    }
    .addr-full {
      display: none;
    }

    @media (min-width: 701px) {
      .addr-short {
        display: none;
      }
      .addr-full {
        display: inline;
      }
    }


    .section-title {
      font-size: 3em;
    }

    @media (max-width:  530px) {
      .section-title {
        font-size: 2em;
      }
    }

    @media (max-width: 580px) {
      .leaderboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .leader-card {
      border: 6px solid var(--font-color);
      border-top-width: 0;
      padding: 1em;
      /*flex-direction: column;*/
      /*background: var(--font-color);*/
      /*color: var(--bg-color);*/
    }
    .leader-card:first-child {
      border-top-width: 6px;
    }
    .leader-card h3 {
      text-align: left;
      margin-bottom: 0.25em;
    }

    .leader-card-content {
      display: flex;
      align-items: center;
      gap: 0.75em;

    }

    .leader-card .address {
      /*color: var(--bg-color);*/
    }

    .leader-card img,
    .leader-card leader-svg {
      width: 100%;
      max-width: 8.95em;
      height: auto;
      display: block;
    }

    @media (max-width: 510px) {
      .leader-card-content {
        flex-direction: column;
        align-items: center;
        font-size: 0.9em;
      }


      .leader-card h3 {
        font-size: 1em;
        text-align: center;
      }

      .leader-info {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .leader-info dd {
        text-align: center;
      }
    }





    .leader-info {
      width: 100%;
    }
    .leader-info h3 {
      text-align: left;
    }

    .leader-info > div {
      margin: 0.25em 0;
    }


    .leader-info dl {
      display: inline-flex;
      flex-direction: column;
      margin: 0.25em 0.5em;
      margin-left: 0;
    }

    .leader-info dt {
      font-size: 0.75em;
      background: var(--font-color);
      color: var(--bg-color);
      /*border:  1px solid;*/
      /*display: block;*/
      padding: 0.25em 0.5em;
      /*width: 100%;*/
    }

    .leader-info dd {
      /*width: 100%;*/
      border: 1px solid;
      padding: 0.25em 0.5em;
      /*display: block;*/
    }



    .section-box {
      border: 6px solid var(--font-color);
      padding: 1.5em;
      margin: 2em auto;
      max-width: 800px;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1em;
      margin-top: 1em;
    }

    .token-item {
      border: 2px solid var(--font-color);
      padding: 0.5em;
      text-align: center;
    }

    .token-item img,
    .token-item leader-svg {
      width: 100%;
      max-width: 120px;
      display: block;
    }

    .erc20-controls {
      display: flex;
      flex-direction: column;
      gap: 1em;
      margin-top: 1em;
    }

    .control-row {
      display: flex;
      gap: 0.5em;
      align-items: center;
      flex-wrap: wrap;
    }

    .blinkSlow {
      animation: Blink 2s steps(2, start) infinite;
    }

    .form-input input {
      width: 20em;
    }
    @media (max-width: 530px) {

      .form-input {
        flex-direction: column;
        align-items: center;
      }
      .form-input input {
        font-size: 1.25em;
        padding: 0.5em;
        width: 100%;
      }

      .form-input button {
        border-left: .15em solid;
        margin-top: 0.25em;
      }
    }



    #docs h3, #docs h4 {
      text-align: left;
    }

    #docs h3 {
      margin-top: 2em;
      font-size: 2em;
    }
    #docs h4 {
      margin-top: 1em;
      font-size: 1.5em;
    }

    #docs p {
      /*text-indent: 1em;*/
      margin-bottom: 2em;
    }

  </style>


  <script src="./utils.js"></script>
  <!-- <script type="module" src="./modal.js"></script> -->
  <script type="module" src="./connectWallet.js"></script>




</head>
<body>
  <div class="center-v" style="margin: 2em 0">

    <svg id="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 487 487" fill="none" style="cursor: pointer;">
      <path d="M465.001 435.5H244.995H20.5L242.75 50L465.001 435.5Z"  stroke-width="14"/>
      <path d="M205.5 348C216 357 227.513 359.224 243.001 359.999C293 362.5 301.001 294.999 243.001 293.499C185.001 291.999 196.5 224.5 243.001 229.998C243.001 229.998 259.5 229.998 276.5 244"  stroke-width="14" stroke-linecap="square"/>
      <line x1="242.5" y1="201" x2="242.5" y2="386"  stroke-width="14"/>
    </svg>

    <h1>Pyramid Game</h1>
  </div>



  <connect-wallet>
    <div slot="connected">

      <section class="center-v">
        <div class="center">
          <input id="topSendEthInput" placeholder="0.01 Ξ" type="number" step="0.01" style="width:10.1em">
          <button id="topSendEthBtn" class="small-button">Send</button>
        </div>
        <div id="topSendEthMessage" style="margin-top: 1em; max-width: 600px;"></div>
        <div id="topSendEthError" class="error-message"></div>
      </section>

    </div>

    <div slot="notConnected">
      <div class="center" style="margin-top: 1em">
        <connect-button>
          <button class="connectButton" slot="button">CONNECT</button>
        </connect-button>
      </div>
    </div>
  </connect-wallet>




  </section>


  <section>
    <connect-wallet>
      <div slot="notConnected">
        <h1 class="slowBlink largeText" style="margin-bottom: 0.25em">$</h1>
      </div>
    </connect-wallet>

    <svg xmlns="http://www.w3.org/2000/svg" width="100%"  viewBox="0 0 1095 225" fill="none">
      <path d="M547 225L590.301 150L503.699 150L547 225ZM539.5 3.27835e-07L539.5 157.5L554.5 157.5L554.5 -3.27835e-07L539.5 3.27835e-07Z" fill="var(--font-color)"/>
    </svg>


    <h2 style="display: flex; align-items: center; justify-content: center; margin: 1em 0">
      <a class="scanlink scanlink-style">
        pyramidgame.eth<svg xmlns="http://www.w3.org/2000/svg" width="0.6em" viewBox="0 0 156 184" fill="none" style="margin-left: 0.25em; margin-top: 0em;">
          <rect x="6" y="6" width="144" height="172" stroke-width="23"/>
          <path d="M32 52H124" stroke-width="15"/>
          <path d="M32 92H124" stroke-width="15"/>
          <path d="M32 131H124" stroke-width="15"/>
        </svg>
      </a>
    </h2>


    <svg id="distribution-svg" xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 1168 702" fill="none">
      <path d="M44 702L87.301 627H0.699L44 702ZM36.5 179L36.5 634.5H51.5L51.5 179H36.5Z" fill="var(--font-color)"/>
      <path d="M142 672L185.301 597H98.699L142 672ZM134.5 179L134.5 604.5H149.5L149.5 179H134.5Z" fill="var(--font-color)"/>
      <path d="M240 641L283.301 566H196.699L240 641ZM232.5 179L232.5 573.5H247.5L247.5 179H232.5Z" fill="var(--font-color)"/>
      <path d="M338 611L381.301 536H294.699L338 611ZM330.5 179L330.5 543.5H345.5L345.5 179H330.5Z" fill="var(--font-color)"/>
      <path d="M436 580L479.301 505H392.699L436 580ZM428.5 179L428.5 512.5H443.5L443.5 179H428.5Z" fill="var(--font-color)"/>
      <path d="M534 550L577.301 475H490.699L534 550ZM526.5 179L526.5 482.5H541.5L541.5 179H526.5Z" fill="var(--font-color)"/>
      <path d="M632 519L675.301 444H588.699L632 519ZM624.5 179L624.5 451.5H639.5L639.5 179H624.5Z" fill="var(--font-color)"/>
      <path d="M730 489L773.301 414H686.699L730 489ZM722.5 179L722.5 421.5H737.5L737.5 179H722.5Z" fill="var(--font-color)"/>
      <path d="M828 458L871.301 383H784.699L828 458ZM820.5 179L820.5 390.5H835.5L835.5 179H820.5Z" fill="var(--font-color)"/>
      <path d="M926 428L969.301 353H882.699L926 428ZM918.5 179L918.5 360.5H933.5L933.5 179H918.5Z" fill="var(--font-color)"/>
      <path d="M1024 397L1067.3 322H980.699L1024 397ZM1016.5 179L1016.5 329.5H1031.5L1031.5 179H1016.5Z" fill="var(--font-color)"/>
      <path d="M1122 367L1165.3 292H1078.7L1122 367ZM1114.5 179L1114.5 299.5H1129.5L1129.5 179H1114.5Z" fill="var(--font-color)"/>
      <line x1="36.5" y1="181.5" x2="1129.5" y2="181.5" stroke-width="15"/>
      <line x1="583" y1="-3.27835e-07" x2="583" y2="189" stroke-width="15"/>
    </svg>

    <div class="center-v">
      <!--
      <h2 style="font-size: 2.675em; margin-bottom: 0.25em;">Leaders <sup style="margin-left: -1em; font-size: 0.5em;"><a href="#faq">?</a></sup></h2>
      -->

      <div class="small-leaders-grid">
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#000;fill:#46ff5a}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#001cff;fill:#46ff5a}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#ff1b1b;fill:#46ff5a}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#46ff5a;fill:#ff1b1b}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#000;fill:#ff1b1b}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#001cff;fill:#ff1b1b}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#ff1b1b;fill:#001cff}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#46ff5a;fill:#001cff}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#000;fill:#001cff}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#001cff;fill:#000}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#ff1b1b;fill:#000}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
        <leader-svg svg='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 576"><style>*{stroke:#46ff5a;fill:#000}</style><rect width="562" height="562" x="7" y="7" stroke-width="14"></rect><path d="M509.501 480H289.495H65L287.25 94.5L509.501 480Z" stroke-width="14"/><path d="M250 392.5C260.5 401.5 272.013 403.724 287.501 404.499C337.5 407 345.501 339.499 287.501 337.999C229.501 336.499 241 269 287.501 274.498C287.501 274.498 304 274.498 321 288.5" stroke-width="14" stroke-linecap="square"/><line x1="287" y1="245.5" x2="287" y2="430.5" stroke-width="14"/></svg>'></leader-svg>
      </div>
    </div>

    <div style="margin: 1em">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%"  viewBox="0 0 1095 225" fill="none">
        <path d="M547 225L590.301 150L503.699 150L547 225ZM539.5 3.27835e-07L539.5 157.5L554.5 157.5L554.5 -3.27835e-07L539.5 3.27835e-07Z" fill="var(--font-color)"/>
      </svg>
    </div>

    <div style="margin: 4em 0; display: flex; justify-content: center;">
      <svg style="height: 100%; width: 220px; max-width: 27.5vw;" xmlns="http://www.w3.org/2000/svg" width="318" height="318" viewBox="0 0 318 318" fill="none">
        <path class="mediumBlink" style="animation-delay: 0s;" d="M317.241 228.479L317.241 141.876L242.242 185.178L317.241 228.479ZM187.494 3.75L180.999 7.5L276.996 173.772L283.491 170.022L289.987 166.272L193.989 6.70552e-07L187.494 3.75Z" fill="var(--font-color)"/>
        <path class="mediumBlink" style="animation-delay: -0.5s;" d="M136.243 3.75623L61.243 47.0575L136.243 90.3588L136.243 3.75623ZM6.49609 228.484L12.9913 232.234L108.988 65.9629L102.493 62.2129L95.9978 58.4629L0.000903785 224.734L6.49609 228.484Z" fill="var(--font-color)"/>
        <path class="mediumBlink" style="animation-delay: -1s;" d="M28.8927 274.615L103.893 317.916L103.893 231.314L28.8927 274.615ZM293.893 274.615V267.115L96.3927 267.115V274.615V282.115L293.893 282.115V274.615Z" fill="var(--font-color)"/>
      </svg>
    </div>

    <div style="margin: 1em">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%"  viewBox="0 0 1095 225" fill="none">
        <path d="M547 225L590.301 150L503.699 150L547 225ZM539.5 3.27835e-07L539.5 157.5L554.5 157.5L554.5 -3.27835e-07L539.5 3.27835e-07Z" fill="var(--font-color)"/>
      </svg>
    </div>

    <h1 class="slowBlink">$</h1>
  </section>

<!--   <section style="display: flex; justify-content: center;">

    <ul>
      <li>Send ETH to <a class="scanlink a-normal">pyramidgame.eth</a></li>
      <li>Get on the <a href="#leaderboard">Leaderboard</a></li>
      <li>Receive future payouts<sup><a href="#disclaimer">*</a></sup></li>
    </ul>
  </section> -->


  <section>
    <nav>
      <a class="a-normal" href="#send">Send →</a>
      <a class="a-normal" href="#leaderboard">Leaderboard →</a>
      <a class="a-normal" href="#docs">Docs →</a>
    </nav>
  </section>

  <!-- 1. How It Works -->
  <section>

    <div id="howItWorksSection">
      <div class="section-box">
        <h2 class="slowBlink" style="animation-delay: -1.5s; margin-bottom: 0.5em;">???</h2>
        <h2>How It Works</h2>
        <ul>
          <li>Pyramid Game is a zero-sum wealth redistribution game that uses cutting-edge pyramid scheme technology. It is not a financial security.</li>
          <li>All ETH sent to Pyramid Game is split proportionally among the 12 <a href="#leaderboard" class="a-normal">leaderboard</a> players based on their prior contributions.</li>
          <li>Leaderboard slots are represented by NFTs, and contributions from non-leaders are represented by the $PYRAMID token.</li>
        </ul>
        <a href="#docs" class="a-normal" style="margin-left: 1.5em;">Learn More →</a>
      </div>
    </div>

  </section>

  <!-- 2. Send Input + Smart Messaging -->
  <section  id="send">
    <connect-wallet>
      <div slot="connected">
        <div id="sendEthSection" class="center-v" style="margin: 2em auto;"></div>
      </div>
    </connect-wallet>
  </section>

  <!-- 3. Leaderboard -->
  <section id="leaderboard">
    <div class="center-v">
      <h2 id="leaderboard-title" class="section-title">Leaderboard<sup style="font-size:0.75em"><a href="#docs-leaderboard">?</a></sup></h2>

      <connect-wallet>
        <div slot="connected">
          <div id="leaderboardStats" style="text-align: center; margin: 1.5em auto; font-size: 1.2em;"></div>
          <div id="leaderboard-board" class="leaderboard-grid">
            <div class="fastBlink" style="text-align: center; padding: 2em;">Loading...</div>
          </div>
        </div>

        <div slot="notConnected">
          <div class="center" style="margin-top: 1em; border: 3px solid; padding: 1.5em">
            <connect-button>
              <button class="connectButton" slot="button" style="font-size: 1.5em">Connect Wallet</button>
              <div slot="loading" class="slowBlink" style="font-size: 1.5em">Connecting...</div>
            </connect-button>
          </div>
        </div>

        <div slot="noWeb3">
          <p style="text-align: center; margin: 2em 0;">View this page with a web3-enabled browser to view the leaderboard</p>
        </div>
      </connect-wallet>
    </div>
  </section>

  <!-- 4. GET STARTED / Connected User Info -->
  <section id="yourAssets">
    <connect-wallet>
<!--       <div slot="notConnected" class="center-v" style="margin: 2em auto;">
        <connect-button>
          <button class="connectButton" slot="button" style="font-size: 1.5em;">Connect Wallet</button>
          <div slot="loading" class="slowBlink" style="font-size: 1.5em">Connecting...</div>
        </connect-button>
      </div> -->

      <div slot="connected" class="center-v" style="margin: 2em auto;">
        <div id="connectedUserInfo"></div>
      </div>
    </connect-wallet>
  </section>

  <!-- 5. User Section -->
  <section>
    <connect-wallet>
      <div slot="connected">
        <div id="userSection">
          <div class="fastBlink" style="text-align: center; padding: 2em;">Loading...</div>
        </div>
      </div>
    </connect-wallet>
  </section>


  <!-- 6. DISTRIBUTIONS -->

  <connect-wallet>
    <div slot="connected">
      <section class="center-v" id="distributions">
        <h2 class="section-title">Latest Distributions</h2>
        <div class="fastBlink" style="text-align: center; padding: 2em;">Loading...</div>
      </section>
    </div>
  </connect-wallet>


  <!-- 7. RELATED GAMES -->
  <connect-wallet>
    <div slot="connected">
      <section class="center-v" id="relatedGames">

        <h2 class="section-title">Related Games<sup style="font-size:0.75em"><a href="#docs-childGames">?</a></sup></h2>
        <div style="max-width: 800px; margin: 1em auto;">
          <div id="childGames">
            <div class="fastBlink" style="text-align: center; padding: 2em;">Loading...</div>
          </div>

          <div style="max-width: 600px; margin: 2em auto 0; border: 2px solid; padding: 1.5em; padding-top: 0.5em;">
            <div style="margin-top: 1em; text-align: center">
              <label style="display: block; margin-bottom: 0.25em;">Initial Contribution:</label>
              <input id="createChildInput" placeholder="0.01 Ξ" type="number" step="0.01" style="width: 10.1em">
            </div>
            <div class="center" style="margin-top: 1.5em;">
              <button id="createChildBtn" class="small-button">Create Child Game</button>
            </div>
            <div id="createChildError" class="error-message" style="text-align: center; margin-top: 0.25em"></div>
          </div>
        </div>
      </section>
    </div>
  </connect-wallet>


  <section id="docs">
    <h2 class="section-title">Documentation</h2>

    <h3 style="margin-top: 1em">Summary</h3>
    <p>All ETH sent to the Pyramid Game contract is split proportionally among the leaders.</p>

    <h3 id="docs-contributions">Contributions</h3>
    <p>The contribution workflow is initiated whenever ETH is sent to the Pyramid Game contract, or an address calls the <code>contribute</code> function. This workflow is split into two phases: distribution and reorg.</p>

    <h4 id="docs-distribution">Distribution</h4>
    <p>In the distribution phase, the value of the contribution is divided among the leaderboard holders. This split is proportional based on how much they have directly or indirectly contributed.</p>

    <!-- TODO: Add interactive example or table showing distribution calculation
         Example structure:
         Leader        Contributed    % Share    Receives (from 1 ETH)
         Bob           2.5 ETH        50%        0.5 ETH
         Charlie       1.0 ETH        20%        0.2 ETH
         Diane         0.75 ETH       15%        0.15 ETH
         Eve           0.5 ETH        10%        0.1 ETH
         Frank         0.25 ETH       5%         0.05 ETH
         Total         5.0 ETH        100%       1.0 ETH
    -->

    <h4 id="docs-reorg">Reorg</h4>
    <p>Following the distribution phase, there is a reorg phase in which the original sender's contribution is accounted for. If their contribution is high enough, this will <a href="#docs-leaderboard">enter them onto the leaderboard</a>. Otherwise, the sender will <a href="#docs-pyramid">receive $PYRAMID as a placeholder</a>.</p>

    <!-- TODO: Add table or diagram showing before/after leaderboard state
         Show how a new contribution triggers reorg and potentially replaces lowest leader
    -->



    <h3 id="docs-leaderboard">Leaderboard</h3>
    <p>Each leaderboard slot is represented by an ERC-721 token with unique onchain art. All distributions are made to token owners (or <a href="#docs-recipient">designated recipients</a>) in proportion to the token's contribution amounts. Note that the contribution amount is tied to the leaderboard token, not the sending address.</p>

    <p>Pyramid Game is configured for a 12-player leaderboard. As a result, the first 12 players to send ETH will join the leaderboard and receive a unique leaderboard token. After this point, the leaderboard token with the lowest contribution amount will be transferred from existing holders to new entrants. Upon transfer, the token's contribution amount will be updated to reflect the new leader's contribution. The displaced leader will be compensated with <a href="#docs-pyramid">$PYRAMID</a> equal to their contribution balance.</p>

    <p>If a player makes a contribution while already owning a leaderboard token, the token's contribution amount will be updated to reflect that transaction. In the event that a player owns multiple leaderboard tokens, only the token with the lowest token ID will be updated.</p>

    <!-- TODO: Add section explaining leaderboard token metadata and artwork generation -->

    <h4 id="docs-recipient">Recipient</h4>
    <p>Owners (or approved operators) of Pyramid Game leaderboard tokens may opt to forward all distributions to another address. The recipient address is reset on token transfer. Recursive payments back to the Pyramid Game contract are disallowed.</p>

    <h3 id="docs-pyramid">$PYRAMID</h3>
    <p>$PYRAMID is an ERC-20 token that acts as a placeholder for all contributions made to Pyramid Game. Players will receive $PYRAMID in two circumstances: (a) if their leaderboard token is transferred to another player during a <a href="#docs-reorg">reorg</a>, they will receive an amount of $PYRAMID equal to their contribution balance; and (b) if a non-leader makes a contribution that does not bring them into the leaderboard, they will receive an amount of $PYRAMID equal to the amount of ETH they sent.</p>

    <p>If a player makes a contribution, and the sum of their contribution amount and current $PYRAMID balance is greater than the lowest leader's contribution amount, then that player will receive the leaderboard token and their outstanding $PYRAMID balance will be burned.</p>

    <p>If a player accrues enough $PYRAMID to enter the leaderboard through the secondary market, they can trigger a manual reorg by calling <code>claimLeaderboardSlot</code>.</p>

    <!-- TODO: Add visual diagram showing $PYRAMID mint/burn mechanics -->

    <p id="docs-contributionBalance">$PYRAMID may also be used to directly increase the contribution amount of a leaderboard token by calling <code>addToLeaderContributionBalance</code>.</p>

    <h3 id="docs-childGames">Child Pyramid Games</h3>
    <p>At any point, a player may create a child Pyramid Game based on a parent game. When creating a new child game, the player must make an initial contribution, which will enter that player into the first slot on the child game's leaderboard. The initial contribution will go towards the parent game. All assets related to the parent game (i.e., leaderboard tokens and $PYRAMID) will go to the child game's <a href="#docs-wallet">leaderboard wallet</a>. As a result, child Pyramid Games may be an effective way to coordinate participation in parent games.</p>


    <h4 id="docs-wallet">Leaderboard Wallet</h4>
    <p>The leaderboard wallet is a multisig that requires a simple majority of votes from all leaders to execute any action. This may involve transferring assets (leaderboard tokens or $PYRAMID), distributing accrued ETH from parent Pyramid Games, updating the metadata of the leaderboard tokens, or upgrading to a new wallet contract.</p>

    <p>To execute a transaction, more than 50% of leaders must sign off-chain messages approving the action. Each signature verifies that the leader (or their approved operator) controls their leaderboard NFT. Once sufficient signatures are collected, anyone can submit the transaction on-chain via <code>executeLeaderTransaction</code>.</p>

    <!-- TODO: Link to wallet interface tool or script examples for generating signatures -->

    <h3 id="docs-contracts">Contract Interfaces</h3>
    <!-- TODO: Auto-generate this section from NatSpec doc comments in Solidity contracts
         Include:
         - Contract addresses on each network
         - Key functions with parameters and descriptions
         - Events emitted by each contract
         - Links to etherscan/basescan for verified contracts
    -->

    <h4>PyramidGame</h4>
    <p>The main contract that manages the distribution mechanism and $PYRAMID.</p>

    <p style="margin: 1em"><strong>Key Functions:</strong></p>
    <div class="listLike">
      <div><code>contribute() payable</code> - Main entry point for sending ETH to the game</div>
      <div><code>claimLeaderboardSlot()</code> - Manually claim a leaderboard slot using your $PYRAMID balance</div>
      <div><code>addToLeaderContributionBalance(tokenId, amount)</code> - Burn $PYRAMID to increase a leader's contribution amount</div>
      <div><code>deployChildPyramidGame(name, tokenSymbol, leaderSymbol) payable</code> - Create a child Pyramid Game</div>
      <div><code>balanceOf(address)</code>, <code>transfer(to, amount)</code>, <code>approve(spender, amount)</code> - Standard ERC-20 functions for $PYRAMID</div>
      <div><code>leaderboard()</code> - Returns the address of the leaderboard contract</div>
      <div><code>wallet()</code> - Returns the address of the multisig wallet contract</div>
    </div>

    <h4>PyramidGameLeaderboard</h4>
    <p>ERC-721 contract managing leaderboard slots.</p>

    <p style="margin: 1em"><strong>Key Functions:</strong></p>
    <div class="listLike">
      <div><code>contributions(tokenId)</code> - Returns the contribution amount for a specific leader token</div>
      <div><code>recipientOf(tokenId)</code> - Returns the distribution recipient address (defaults to token owner)</div>
      <div><code>setRecipient(tokenId, address)</code> - Set a custom recipient for distributions</div>
      <div><code>lowestLeader()</code> - Returns the token ID and contribution amount of the lowest leader</div>
      <div><code>getAllLeaderData()</code> - Batch read all leader data in a single call</div>
      <div><code>contributionTotal()</code> - Returns the sum of all leader contribution balances</div>
    </div>

    <h4>PyramidGameLeaderboardWallet</h4>
    <p>Multisig wallet contract controlled by leaderboard NFT holders.</p>

    <p style="margin: 1em"><strong>Key Functions:</strong></p>
    <div class="listLike">
      <div><code>executeLeaderTransaction(target, value, data, nonce, tokenIds[], signatures[])</code> - Execute a transaction with majority approval</div>
      <div><code>nonceUsed(nonce)</code> - Check if a nonce has been used (prevents replay attacks)</div>
    </div>

    <p><strong>Signature Format:</strong> Leaders sign EIP-191 formatted messages containing <code>keccak256(abi.encode(target, value, data, nonce))</code>. Each signature must correspond to a leader NFT owner or approved operator.</p>

    <!-- TODO: Add helper tools/scripts for generating signatures and coordinating multisig transactions -->


    <!-- TODO: Add code examples for listening to events with ethers.js/web3.js -->

  </section>


  <footer style="margin: 4em auto;"><a href="https://steviep.xyz" target="_blank" style="text-decoration: underline;">steviep.xyz</a> 2025</footer>



<!--     <div class="block" style="background: var(--black-color); color: var(--red-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--gray-color); color: var(--green-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--white-color); color: var(--red-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--green-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--cyan-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--blue-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--magenta-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>

    <div class="block" style="background: var(--red-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>


    <div class="block" style="background: var(--orange-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>

    <div class="block" style="background: var(--yellow-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
 -->


</body>



<script type="module">
  import {provider, etherscanAddr, addEtherscanLinks, ethVal, txValue} from './eth.js'
  import {CONTRACTS} from './contracts.js'
  import {$, queryParams} from './$.js'
  import {simulateDistributions} from './distributionSimulator.js'

  // Store original root game addresses before any modifications
  const ROOT_GAME_ADDRESSES = {
    local: CONTRACTS.PyramidGame.addr.local,
    sepolia: CONTRACTS.PyramidGame.addr.sepolia,
    base: CONTRACTS.PyramidGame.addr.base,
    mainnet: CONTRACTS.PyramidGame.addr.mainnet
  }

  // Function to load custom game details from URL parameter
  async function loadCustomGame() {
    const customGameAddress = queryParams.address

    if (!customGameAddress || !ethers.utils.isAddress(customGameAddress)) {
      return
    }

    try {
      // Get network and create contract instance
      const { name: networkKey } = await provider.getNetwork()
      const customGame = await provider.contract(customGameAddress, CONTRACTS.PyramidGame.abi)

      // Fetch game details
      const [gameName, leaderboardAddr] = await Promise.all([
        customGame.name(),
        customGame.leaderboard()
      ])

      // Update h1 with game name
      const $h1 = document.querySelector('h1')
      if ($h1 && gameName) {
        $h1.textContent = gameName
      }

      // Update CONTRACTS with custom addresses
      CONTRACTS.PyramidGame.addr[networkKey] = customGameAddress
      CONTRACTS.PyramidGameLeaderboard.addr[networkKey] = leaderboardAddr

      // Try to get wallet address if the contract has one
      try {
        const walletAddr = await customGame.wallet()
        if (walletAddr && ethers.utils.isAddress(walletAddr)) {
          CONTRACTS.PyramidGameLeaderboardWallet.addr[networkKey] = walletAddr
        }
      } catch (e) {
        // Wallet function may not exist, silently continue
      }
    } catch (e) {
      // Silently fail and use default contracts
    }
  }

  // Define leader-svg web component with isolated styles
  class LeaderSVG extends HTMLElement {
    constructor() {
      super()
      this.attachShadow({ mode: 'open' })
    }

    connectedCallback() {
      const svg = this.getAttribute('svg')
      if (svg) {
        this.shadowRoot.innerHTML = `
          <style>
            :host {
              display: block;
              width: 100%;
              height: auto;
            }
            svg {
              width: 100%;
              height: auto;
              display: block;
            }
          </style>
          ${svg}
        `
      }
    }
  }
  customElements.define('leader-svg', LeaderSVG)

  provider.setContractInfo(CONTRACTS)
  addEtherscanLinks('scanlink', 'PyramidGame')

  // Helper functions
  const utf8Clean = raw => raw.replace(/data.*utf8,/, '')
  const b64Clean = raw => raw.replace(/data.*,/, '')

  const handleTx = (txFn, errorId) => async () => {
    const { etherscanLink, addr } = await provider.getNetwork()

    $.id(errorId).innerHTML = 'Pending...'
    try {
      const tx = await txFn()
      $.id(errorId).innerHTML = `<span class="blinkSlow">TX Pending.</span> <a href="https://${etherscanLink}/tx/${tx.hash}" target="_blank" rel="nofollow">View on etherscan</a>`
      await tx.wait(1)
      renderPage(addr)
      $.id(errorId).innerHTML = 'Success!'
      setTimeout(() => {
        $.id(errorId).innerHTML = ''
      }, 4000)
    } catch (e) {
      $.id(errorId).innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
      console.error(e)
    }
  }

  const extractSVG = jsonURI => {
    try {
      const imageDataURI = jsonURI.image
      const svgMarkup = atob(b64Clean(imageDataURI))
      return svgMarkup
    } catch (e) {
      console.error('Error extracting SVG:', e)
      return ''
    }
  }

  const timeAgo = timestamp => {
    const now = Date.now()
    const diff = Math.floor((now - timestamp) / 1000)

    if (diff < 60) return `${diff} second${diff === 1 ? '' : 's'} ago`
    if (diff < 3600) {
      const mins = Math.floor(diff / 60)
      return `${mins} minute${mins === 1 ? '' : 's'} ago`
    }
    if (diff < 86400) {
      const hours = Math.floor(diff / 3600)
      return `${hours} hour${hours === 1 ? '' : 's'} ago`
    }
    if (diff < 31536000) {
      const days = Math.floor(diff / 86400)
      return `${days} day${days === 1 ? '' : 's'} ago`
    }
    const years = Math.floor(diff / 31536000)
    return `${years} year${years === 1 ? '' : 's'} ago`
  }

  const calculateProjection = (sortedLeaders, contributionTotal) => (inputAmount) => {
    if (!inputAmount || inputAmount <= 0) return null
    return sortedLeaders.map(l => {
      const share = (inputAmount * l.contribution) / contributionTotal
      const percentage = (l.contribution / contributionTotal) * 100
      return { ...l, share: share, percentage: percentage }
    })
  }

  const renderLeaderboard = (sortedLeaders, etherscanLink, leaderboardAddr) => {
    return sortedLeaders.map(l => {
      const escapedSVG = l.svg.replace(/"/g, '&quot;')
      return `
        <div class="leader-card">
          <h3>${l.tokenName}</h3>
          <div class="leader-card-content">
            <leader-svg svg="${escapedSVG}" style="${[5,7,9].includes(l.tokenId) ? 'border: 1px solid' : ''}"></leader-svg>
            <div class="leader-info">
              <dl>
                <dt>OWNER</dt>
                <dd>
                  <span class="addr-short">${etherscanAddr(etherscanLink, l.owner, l.prettyAddrShort)}</span>
                  <span class="addr-full">${etherscanAddr(etherscanLink, l.owner, l.prettyAddr)}</span>
                </dd>
              </dl>
              <div>
                <dl>
                  <dt>SENT</dt>
                  <dd>
                    <span style="margin-right: 0.25em">Ξ</span><strong>${l.contribution.toFixed(4)}</strong>
                  </dd>
                </dl>
                <dl>
                  <dt>% OF NEXT PAYOUT</dt>
                  <dd>
                    <strong>${l.percentage.toFixed(2)}%</strong>
                  </dd>
                </dl>
              </div>
              <strong style="font-size: 0.75em"><a href="https://opensea.io/item/ethereum/${leaderboardAddr}/${l.tokenId}" target="_blank" rel="nofollow">View on OpenSea →</a></strong>
            </div>
          </div>
        </div>
      `
    }).join('')
  }

  const createUpdateSendMessage = ({
    erc20Balance,
    userIsLeader,
    lowestLeader,
    userTokens,
    leaderContributionTotal,
    activeLeaderse,
    getProjection,
    inputId = 'sendEthInput',
    messageId = 'sendEthMessage'
  }) => () => {
    const amount = parseFloat($.id(inputId).value)
    if (!amount || amount <= 0) {
      $.id(messageId).innerHTML = ''
      return
    }

    const newErc20Balance = erc20Balance + amount

    let message = ''

    if (userIsLeader) {
      const userTotalContribution = userTokens.reduce((sum, t) => sum + t.contribution, 0)
      const newUserTotal = userTotalContribution + amount
      const newContributionTotal = leaderContributionTotal + amount
      const newPercentage = (newUserTotal / newContributionTotal) * 100
      message = `<p style="text-align: center">You are already on the Leaderboard! This transaction would increase your distribution payouts to <strong>${newPercentage.toFixed(2)}%</strong>.</p>`
    } else {
      if (newErc20Balance > lowestLeader.contribution) {
        const newPercentage = (amount / (leaderContributionTotal + amount)) * 100
        message = `<p style="text-align: center"><strong>This transaction would give you a Leaderboard slot.</strong></p>
                  ${erc20Balance ? `<p style="text-align: center">(Your balance of <strong>${erc20Balance.toFixed(4)} $PYRAMID</strong> will burned)</p>` : ''}
                   <p style="text-align: center">You would receive <strong>${newPercentage.toFixed(2)}%</strong> of future payouts.</p>`
      } else {
        message = `<p style="text-align: center">This is not enough to enter the Leaderboard. You would need to send at least <strong><span style="margin-right: 0.25em">Ξ</span>${(lowestLeader.contribution + 0.0001 - erc20Balance).toFixed(4)}</strong>.</p> <p style="text-align: center">However, you would receive <strong>${amount.toFixed(4)} $PYRAMID</strong> from this transaction.</p>`
      }
    }

    message = `<div style="margin-top: 1.5em; margin-bottom: 3em">${message}</div>`

    // Add projection table with arrow
    const projection = getProjection(amount)
    message += `
      <div style="margin-top: 1em;">
        <p style="text-align: center"><strong>Your Ξ${amount} would be split ${activeLeaderse} ways:</strong></p>
        <div style="margin: 0.5em auto; width: 400px; max-width: 90vw;">
          ${projection.map((l, index) => `
            <div style="padding: 0.5em 0; ${index < projection.length - 1 ? 'border-bottom: 1px dashed;' : ''}">
              <div style="display: flex; align-items: center; gap: 0.25em; margin-bottom: 0.25em;">
                <span style="display: inline-block; width: ${l.percentage}%; background: var(--font-color); height: 3px; border: 1px solid var(--font-color);"></span>
                <span style="font-size: 0.6em;">${l.percentage.toFixed(1)}%</span>
              </div>
              <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 0.25em;">
                <span><span style="margin-right: 0.25em">Ξ</span><strong>${l.share.toFixed(4)}</strong></span>
                <span style="font-size: 1.5em; padding: 0 1em">→</span>
                <span>${l.prettyAddrShort}</span>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `

    $.id(messageId).innerHTML = message
  }

  // Main render function
  async function renderPage(addr) {
    // === Fetch all data ===
    const { PyramidGame } = await provider.getContracts()
    const { name: chainName, etherscanLink } = await provider.getNetwork()

    const [leaderboardAddr, pyramidSymbol] = await Promise.all([
      PyramidGame.leaderboard(),
      PyramidGame.symbol()
    ])
    const PyramidGameLeaderboard = await provider.contract(leaderboardAddr, CONTRACTS.PyramidGameLeaderboard.abi)

    // Fetch all leader data in a single batch call
    const [leaderDataArray, leaderContributionTotalRaw] = await PyramidGameLeaderboard.getAllLeaderData()
    const activeLeaderse = leaderDataArray.length
    const leaderContributionTotal = ethVal(leaderContributionTotalRaw)

    // Fetch remaining data (tokenURI and approvals) for each leader
    const leaders = await Promise.all(leaderDataArray.map(async (leaderData, i) => {
      const owner = leaderData.owner
      const contribution = ethVal(leaderData.contribution)
      const recipientAddr = leaderData.recipient

      const [prettyAddrShort, prettyAddr, tokenURI, approvedAddr] = await Promise.all([
        provider.formatAddr(owner),
        provider.formatAddr(owner, false),
        PyramidGameLeaderboard.tokenURI(i),
        PyramidGameLeaderboard.getApproved(i)
      ])

      const svg = extractSVG(JSON.parse(utf8Clean(tokenURI)))
      const tokenName = JSON.parse(utf8Clean(tokenURI)).name
      const percentage = (contribution / leaderContributionTotal) * 100
      const recipient = recipientAddr !== ethers.constants.AddressZero ? recipientAddr : null
      const recipientPretty = recipient ? await provider.formatAddr(recipient, false) : null
      const approved = approvedAddr !== ethers.constants.AddressZero ? approvedAddr : null
      const approvedPretty = approved ? await provider.formatAddr(approved, false) : null

      return {
        tokenId: i,
        tokenName,
        owner,
        prettyAddr,
        prettyAddrShort,
        contribution,
        svg,
        percentage,
        recipient,
        recipientPretty,
        approved,
        approvedPretty
      }
    }))

    // Sort by contribution (highest first)
    const sortedLeaders = leaders.sort((a, b) => b.contribution - a.contribution)
    const lowestLeader = sortedLeaders[sortedLeaders.length - 1]

    // Calculate total contributions
    const pyramidTotalSupply = ethVal(await PyramidGame.totalSupply())
    const totalContributed = leaderContributionTotal + pyramidTotalSupply

    // Render stats
    $.id('leaderboardStats').innerHTML = `
      <div style="display: flex; justify-content: center; gap: 0.5em 2em; flex-wrap: wrap;">
        <div><strong>Total Sent:</strong> <span style="margin-right: 0.25em">Ξ</span>${totalContributed.toFixed(4)}</div>
        <div><strong>Sent by Leaders:</strong> <span style="margin-right: 0.25em">Ξ</span>${leaderContributionTotal.toFixed(4)}</div>
        <div><strong>Lowest Leader:</strong> #${lowestLeader.tokenId} (<span style="margin-right: 0.25em">Ξ</span>${lowestLeader.contribution.toFixed(4)})</div>
      </div>
    `

    // Render leaderboard grid
    $.id('leaderboard-board').innerHTML = renderLeaderboard(sortedLeaders, etherscanLink, leaderboardAddr)

    // Get user's tokens
    const userTokens = leaders.filter(l => l.owner.toLowerCase() === addr.toLowerCase())
    const leaderSlotIds = userTokens.map(l => l.tokenId)

    // Get user's ERC20 balance
    const erc20Balance = ethVal(await PyramidGame.balanceOf(addr))

    // Fetch events once for both simulation and rendering
    const contributionEvents = await provider.contractEvents(PyramidGame, 'Contribution', [])
    const transferEvents = await provider.contractEvents(PyramidGameLeaderboard, 'Transfer', [])

    // Get parent address to handle initial contribution correctly
    let parentAddress = null
    try {
      parentAddress = await PyramidGame.parent()
    } catch (e) {
      // Parent function may not exist on older contracts
    }

    // Simulate distributions to calculate sent/received totals
    const { sentTotals, receivedTotals } = simulateDistributions(contributionEvents, transferEvents, activeLeaderse, parentAddress)
    const userSent = sentTotals[addr.toLowerCase()] || 0
    const userReceived = receivedTotals[addr.toLowerCase()] || 0

    const userIsLeader = userTokens.length > 0
    const getProjection = calculateProjection(sortedLeaders, leaderContributionTotal)

    // === 2. Send ETH Section with Smart Messaging ===
    const prettyAddr = await provider.formatAddr(addr)
    $.id('sendEthSection').innerHTML = `
      <div style="text-align: center; margin-bottom: 1em;">
        <h3><strong>Connected as:</strong> ${prettyAddr}</h3>

        <div class="invert" style="padding: 0.5em">
          ${erc20Balance > 0 ? `<p>Your $PYRAMID Balance: <strong>${erc20Balance.toFixed(4)}</strong></p>` : ''}
          ${!userIsLeader ? `<p>Lowest Leaderboard contribution: <strong><span style="margin-right: 0.25em">Ξ</span>${lowestLeader.contribution.toFixed(4)}</strong></p>` : ''}
          ${userIsLeader ? `<p>Your Leaderboard Slot${userTokens.length > 1 ? 's' : ''}: <strong>${userTokens.map(l => l.tokenId + ` (${l.percentage.toFixed(2)}%)`).join(', ')}</strong></p>` : ''}
        </div>
      </div>
      <div class="center">
        <input id="sendEthInput" placeholder="0.01 Ξ" type="number" step="0.01" style="width:10.1em">
        <button id="sendEthBtn" class="small-button">Send</button>
      </div>
      <div id="sendEthMessage" style="margin-top: 1em; max-width: 600px;"></div>
      <div id="sendEthError" class="error-message"></div>
    `


    const sendEthInput = $.id('sendEthInput')
    if (sendEthInput) {
      sendEthInput.oninput = createUpdateSendMessage({
        erc20Balance,
        userIsLeader,
        lowestLeader,
        userTokens,
        leaderContributionTotal,
        activeLeaderse,
        getProjection
      })
    }

    const sendEthBtn = $.id('sendEthBtn')
    if (sendEthBtn) {
      sendEthBtn.onclick = handleTx(async () => {
        $.id('sendEthMessage').innerHTML = ''
        const amount = parseFloat($.id('sendEthInput').value)
        if (!amount || amount <= 0) {
          throw new Error('Invalid amount')
        }
        return await PyramidGame.contribute(txValue(amount))
      }, 'sendEthError')
    }

    // Wire up top send ETH input/button
    const topSendEthInput = $.id('topSendEthInput')
    if (topSendEthInput) {
      topSendEthInput.oninput = createUpdateSendMessage({
        erc20Balance,
        userIsLeader,
        lowestLeader,
        userTokens,
        leaderContributionTotal,
        activeLeaderse,
        getProjection,
        inputId: 'topSendEthInput',
        messageId: 'topSendEthMessage'
      })
    }

    const topSendEthBtn = $.id('topSendEthBtn')
    if (topSendEthBtn) {
      topSendEthBtn.onclick = handleTx(async () => {
        $.id('topSendEthMessage').innerHTML = ''
        const amount = parseFloat($.id('topSendEthInput').value)
        if (!amount || amount <= 0) {
          throw new Error('Invalid amount')
        }
        return await PyramidGame.contribute(txValue(amount))
      }, 'topSendEthError')
    }

    // === 4. Connected User Info ===
    const userTotalContribution = userTokens.reduce((sum, t) => sum + t.contribution, 0) + erc20Balance
    const userPercentage = userSent > 0 ? (userSent / totalContributed) * 100 : 0

    $.id('connectedUserInfo').innerHTML = (userIsLeader || erc20Balance > 0 || userSent > 0 || userReceived > 0) ? `
      <div class="center-v">
        <h2 class="section-title">Your Assets</h2>
        ${userReceived > 0 ? `
          <h3>Total Received: <span style="margin-right: 0.25em">Ξ</span>${userReceived.toFixed(4)}</h3>
        ` : ''}
        ${userSent > 0 ? `
          <h3>Total Sent: <span style="margin-right: 0.25em">Ξ</span>${userSent.toFixed(4)}</h3>
          <p>This is ${userPercentage.toFixed(2)}% of all contributions made</p>
        ` : ''}
        ${userIsLeader ? `
          <h3>Leaderboard Slot${userTokens.length > 1 ? 's' : ''} Held: ${userTokens.map(t => `#${t.tokenId}`).join(', ')}</h3>
          <h3>Your Payout: ${((userTokens.reduce((sum, t) => sum + t.contribution, 0) / leaderContributionTotal) * 100).toFixed(2)}%</h3>
        ` : ''}
        ${erc20Balance > 0 ? `
          <h3>$PYRAMID Balance: ${erc20Balance.toFixed(4)}</h3>
          <div class="center" style="margin-top: 0.5em;">
            <button id="addPyramidToWalletBtn" class="small-button">Add $${pyramidSymbol} to wallet</button>
          </div>
        ` : ''}
      </div>
    ` : ''

    // Wire up add PYRAMID to wallet button
    const addPyramidToWalletBtn = $.id('addPyramidToWalletBtn')
    if (addPyramidToWalletBtn) {
      addPyramidToWalletBtn.onclick = async () => {
        await provider.addCoin(PyramidGame.address, pyramidSymbol)
      }
    }

    // === 5. User Section ===
    let userSectionHTML = ''

    // If user has ERC20 balance
    if (erc20Balance > 0) {
      const canClaimLeaderboardSlot = erc20Balance > lowestLeader.contribution

      if (!userIsLeader) {
        if (canClaimLeaderboardSlot) {
          userSectionHTML += `
            <div class="section-box center-v">
              <p>Your $PYRAMID balance is high enough to get on the Leaderboard</p>
              <button id="claimLeadershipBtn" class="tiny-button">Claim Leaderboard Slot</button>
              <div id="claimError" class="error-message"></div>
            </div>
          `
        } else {
          userSectionHTML += `
            <div class="section-box center-v">
              <p>Lowest Leaderboard contribution: <strong><span style="margin-right: 0.25em">Ξ</span>${lowestLeader.contribution.toFixed(4)}</strong></p>
              <p>You need to send <strong><span style="margin-right: 0.25em">Ξ</span>${(lowestLeader.contribution + 0.0001 - erc20Balance).toFixed(4)}</strong> to claim a Leaderboard slot</p>

              <div class="center" style="margin-top: 1.5em;">
                <input id="sendMoreEthInput" placeholder="0.01 Ξ" type="number" step="0.01" style="width:10.1em">
                <button id="sendMoreEthBtn" class="small-button">Send</button>
              </div>
              <div id="sendMoreEthMessage" style="margin-top: 1em;"></div>
              <div id="sendMoreEthError" class="error-message"></div>
            </div>
          `
        }
      }
    }

    // For each leaderboard slot NFT
    if (userIsLeader) {
      userSectionHTML += userTokens.map(t => {
        const escapedSVG = t.svg.replace(/"/g, '&quot;')
        return `
          <div class="section-box center-v">
            <h3>${t.tokenName}</h3>
            <leader-svg svg="${escapedSVG}" style="max-width: 300px; margin-top: 0.5em"></leader-svg>
            <div style="margin: 0.25em 0"><strong>Contribution Balance:</strong> <span style="margin-right: 0.25em">Ξ</span>${t.contribution.toFixed(4)}</div>
            <div><strong>Payout:</strong> ${t.percentage.toFixed(2)}%</div>

            <div style="margin-top: 2em;">
              ${t.approved ? `<p>${etherscanAddr(etherscanLink, t.approved, t.approvedPretty)} is approved to transfer this Leaderboard slot.</p>` : ''}
              <div class="center form-input" style="margin-top: 0.25em">
                <input id="approveSlot${t.tokenId}" class="tiny-input" placeholder="0x..." >
                <button id="approveSlotBtn${t.tokenId}" class="small-button">Approve</button>
                <div id="approveSlotError${t.tokenId}" class="error-message"></div>
              </div>
            </div>

            <div style="margin-top: 2em;">
              <div class="center form-input" style="margin-top: 0.25em">
                <input id="transferSlot${t.tokenId}" class="tiny-input" placeholder="0x..." >
                <button id="transferSlotBtn${t.tokenId}" class="small-button">Transfer</button>
                <div id="transferSlotError${t.tokenId}" class="error-message"></div>
              </div>
            </div>

            ${erc20Balance > 0 ? `
              <div style="margin-top: 2em;">
                <h4 style="margin-top: 1em; text-align: center">Add $PYRAMID to slot contribution balance<sup><a href="#docs-contributionBalance">?</a></sup></h4>
                <div class="center form-input" style="margin-top: 0.25em">
                  <input id="addContribAmount${t.tokenId}" class="tiny-input" placeholder="${erc20Balance.toFixed(2)} $PYRAMID">
                  <button id="addContribBtn${t.tokenId}" class="small-button">Add</button>
                  <div id="addContribMessage${t.tokenId}" style="margin-top: 0.5em; text-align: center;"></div>
                  <div id="addContribError${t.tokenId}" class="error-message"></div>
                </div>
              </div>
            ` : ''}

            <div style="margin-top: 2em;">
              ${t.recipient !== addr ? `<p>${etherscanAddr(etherscanLink, t.recipient, t.recipientPretty)} is currently receiving this Leaderboard slot's payouts.</p>` : ''}
              <h4 style="margin-top: 1em; text-align: center">Set Payout Recipient<sup><a href="#docs-recipient">?</a></sup></h4>
              <div class="center form-input" style="margin-top: 0.25em">
                <input id="setRecipient${t.tokenId}" class="tiny-input" placeholder="0x..." >
                <button id="setRecipientBtn${t.tokenId}" class="small-button">Set</button>
                <div id="setRecipientError${t.tokenId}" class="error-message"></div>
              </div>
            </div>

          </div>
        `
      }).join('')

      // Add Advanced section for wallet operations
      userSectionHTML += `
        <div class="section-box center-v">
          <h2>Advanced<sup style="font-size:0.75em"><a href="#docs-wallet">?</a></sup></h2>
          <h4 style="margin-top: 1em; text-align: center">Sign Wallet Transaction</h4>
          <div style="max-width: 600px; margin: 0 auto;">
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Target Address:</label>
              <input id="walletTxTarget" class="tiny-input" placeholder="0x..." style="width: 100%;">
            </div>
            <div style="margin-top: 1em; display: flex; gap: 1em;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.25em;">Nonce:</label>
                <input id="walletTxNonce" class="tiny-input" placeholder="0" type="number" style="width: 100%;">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.25em;">Value (ETH):</label>
                <input id="walletTxValue" class="tiny-input" placeholder="0.00" step="0.01" type="number" style="width: 100%;">
              </div>
            </div>
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Function Signature:</label>
              <input id="walletTxFnSig" class="tiny-input" placeholder="transfer(address,uint256)" style="width: 100%;">
            </div>
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Function Arguments (JSON array):</label>
              <input id="walletTxArgs" class="tiny-input" placeholder='["0x...", "1000000000000000000"]' style="width: 100%;">
            </div>
            <div class="center" style="margin-top: 1.5em;">
              <button id="signWalletTxBtn" class="small-button">Sign Message</button>
            </div>
            <div id="walletTxSignature" style="margin-top: 1em; word-break: break-all; text-align: center;"></div>
            <div id="walletTxError" class="error-message"></div>
          </div>

          <h4 style="margin-top: 2em; text-align: center">Execute Leader Transaction</h4>
          <div style="max-width: 600px; margin: 0 auto;">
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Target Address:</label>
              <input id="execTxTarget" class="tiny-input" placeholder="0x..." style="width: 100%;">
            </div>
            <div style="margin-top: 1em; display: flex; gap: 1em;">
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.25em;">Nonce:</label>
                <input id="execTxNonce" class="tiny-input" placeholder="0" type="number" style="width: 100%;">
              </div>
              <div style="flex: 1;">
                <label style="display: block; margin-bottom: 0.25em;">Value (ETH):</label>
                <input id="execTxValue" class="tiny-input" placeholder="0.00" step="0.01" type="number" style="width: 100%;">
              </div>
            </div>
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Encoded Data (0x...):</label>
              <input id="execTxData" class="tiny-input" placeholder="0x..." style="width: 100%;">
            </div>
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Leader Token IDs (JSON array):</label>
              <input id="execTxTokenIds" class="tiny-input" placeholder='[0, 1, 2]' style="width: 100%;">
            </div>
            <div style="margin-top: 1em;">
              <label style="display: block; margin-bottom: 0.25em;">Signatures (JSON array):</label>
              <input id="execTxSignatures" class="tiny-input" placeholder='["0x...", "0x..."]' style="width: 100%;">
            </div>
            <div class="center" style="margin-top: 1.5em;">
              <button id="execLeaderTxBtn" class="small-button">Execute Transaction</button>
            </div>
            <div id="execTxError" class="error-message"></div>
          </div>

          <a class="canlink-style" href="https://etherscan.io/address/0xcc88a0a881561148A8DaC357e385142Bb724057a" target="_blank" rel="nofollow" style="margin-top: 1em">
            PyramidGameWallet<svg xmlns="http://www.w3.org/2000/svg" width="0.6em" viewBox="0 0 156 184" fill="none" style="margin-left: 0.25em; margin-top: 0em;">
              <rect x="6" y="6" width="144" height="172" stroke-width="23"/>
              <path d="M32 52H124" stroke-width="15"/>
              <path d="M32 92H124" stroke-width="15"/>
              <path d="M32 131H124" stroke-width="15"/>
            </svg>
          </a>
        </div>
      `
    }

    // Check if PG has ETH balance
    const pgBalance = ethVal(await provider.provider.getBalance(PyramidGame.address))
    if (pgBalance > 1e-8) {
      userSectionHTML += `
        <div class="section-box center-v">
          <h2>Force Distribution</h2>
          <p>Pyramid Game contract balance: <span style="margin-right: 0.25em">Ξ</span>${pgBalance.toFixed(4)}</p>
          <button id="forceDistributeBtn" class="tiny-button">Force Distribution</button>
          <div id="forceDistributeError" class="error-message"></div>
        </div>
      `
    }

    $.id('userSection').innerHTML = userSectionHTML

    // Wire up event handlers
    if (userIsLeader) {
      userTokens.forEach(t => {
        // Set recipient button
        const setRecipientBtn = $.id(`setRecipientBtn${t.tokenId}`)
        if (setRecipientBtn) {
          setRecipientBtn.onclick = handleTx(async () => {
            const recipientInput = $.id(`setRecipient${t.tokenId}`).value
            const recipient = provider.isENS(recipientInput)
              ? await provider.fromENS(recipientInput)
              : recipientInput
            return await PyramidGameLeaderboard.setRecipient(t.tokenId, recipient)
          }, `setRecipientError${t.tokenId}`)
        }

        // Approve slot button
        const approveSlotBtn = $.id(`approveSlotBtn${t.tokenId}`)
        if (approveSlotBtn) {
          approveSlotBtn.onclick = handleTx(async () => {
            const approveInput = $.id(`approveSlot${t.tokenId}`).value
            const approvedAddress = provider.isENS(approveInput)
              ? await provider.fromENS(approveInput)
              : approveInput
            return await PyramidGameLeaderboard.approve(approvedAddress, t.tokenId)
          }, `approveSlotError${t.tokenId}`)
        }

        // Transfer slot button
        const transferSlotBtn = $.id(`transferSlotBtn${t.tokenId}`)
        if (transferSlotBtn) {
          transferSlotBtn.onclick = handleTx(async () => {
            const transferInput = $.id(`transferSlot${t.tokenId}`).value
            const transferTo = provider.isENS(transferInput)
              ? await provider.fromENS(transferInput)
              : transferInput
            return await PyramidGameLeaderboard.transferFrom(addr, transferTo, t.tokenId)
          }, `transferSlotError${t.tokenId}`)
        }

        // Add contribution button
        if (erc20Balance > 0) {
          const addContribInput = $.id(`addContribAmount${t.tokenId}`)
          if (addContribInput) {
            addContribInput.oninput = () => {
              const amount = parseFloat(addContribInput.value)
              const messageEl = $.id(`addContribMessage${t.tokenId}`)
              if (messageEl) {
                if (!amount || amount <= 0) {
                  messageEl.innerHTML = ''
                } else {
                  messageEl.innerHTML = `This will burn <strong>${amount.toFixed(4)} $PYRAMID</strong> and increase your Leaderboard slot's contribution balance by <strong><span style="margin-right: 0.25em">Ξ</span>${amount.toFixed(4)}</strong>`
                }
              }
            }
          }

          const btn = $.id(`addContribBtn${t.tokenId}`)
          if (btn) {
            btn.onclick = handleTx(async () => {
              const messageEl = $.id(`addContribMessage${t.tokenId}`)
              if (messageEl) messageEl.innerHTML = ''
              const amount = parseFloat($.id(`addContribAmount${t.tokenId}`).value)
              const tokenAmount = ethers.utils.parseEther(String(amount))
              return await PyramidGame.addToLeaderContributionBalance(t.tokenId, tokenAmount)
            }, `addContribError${t.tokenId}`)
          }
        }
      })

      // Sign wallet transaction button
      const signWalletTxBtn = $.id('signWalletTxBtn')
      if (signWalletTxBtn) {
        signWalletTxBtn.onclick = async () => {
          const errorEl = $.id('walletTxError')
          const signatureEl = $.id('walletTxSignature')

          try {
            errorEl.innerHTML = ''
            signatureEl.innerHTML = ''

            const target = $.id('walletTxTarget').value
            const nonce = parseInt($.id('walletTxNonce').value || '0')
            const valueInput = parseFloat($.id('walletTxValue').value || '0')
            const value = ethers.utils.parseEther(String(valueInput))
            const fnSig = $.id('walletTxFnSig').value
            const argsInput = $.id('walletTxArgs').value

            // Parse arguments
            const args = argsInput ? JSON.parse(argsInput) : []

            // Encode function data
            const iface = new ethers.utils.Interface([`function ${fnSig}`])
            const fnName = fnSig.split('(')[0]
            const data = iface.encodeFunctionData(fnName, args)

            // Create message hash to sign
            const messageHash = ethers.utils.solidityKeccak256(
              ['address', 'uint256', 'uint256', 'bytes'],
              [target, nonce, value, data]
            )

            // Sign the message
            const signer = provider.provider.getSigner()
            const signature = await signer.signMessage(ethers.utils.arrayify(messageHash))

            signatureEl.innerHTML = `
              <p><strong>Signature:</strong></p>
              <p style="font-family: monospace; background: var(--gray-color); padding: 0.5em; margin-top: 0.5em;">${signature}</p>
              <p style="margin-top: 0.5em;"><strong>Message Hash:</strong></p>
              <p style="font-family: monospace; background: var(--gray-color); padding: 0.5em; margin-top: 0.5em;">${messageHash}</p>
              <p style="margin-top: 0.5em;"><strong>Encoded Data:</strong></p>
              <p style="font-family: monospace; background: var(--gray-color); padding: 0.5em; margin-top: 0.5em;">${data}</p>
            `
          } catch (e) {
            errorEl.innerHTML = e?.message || 'Something went wrong'
            console.error(e)
          }
        }
      }

      // Execute leader transaction button
      const execLeaderTxBtn = $.id('execLeaderTxBtn')
      if (execLeaderTxBtn) {
        execLeaderTxBtn.onclick = handleTx(async () => {
          const target = $.id('execTxTarget').value
          const nonce = parseInt($.id('execTxNonce').value || '0')
          const valueInput = parseFloat($.id('execTxValue').value || '0')
          const value = ethers.utils.parseEther(String(valueInput))
          const data = $.id('execTxData').value
          const tokenIdsInput = $.id('execTxTokenIds').value
          const signaturesInput = $.id('execTxSignatures').value

          // Parse arrays
          const leaderTokenIds = JSON.parse(tokenIdsInput)
          const signatures = JSON.parse(signaturesInput)

          return await PyramidGame.executeLeaderTransaction(
            target,
            value,
            data,
            nonce,
            leaderTokenIds,
            signatures
          )
        }, 'execTxError')
      }
    }

    if (erc20Balance > 0 && !userIsLeader) {
      const canClaimLeaderboardSlot = erc20Balance > lowestLeader.contribution

      if (canClaimLeaderboardSlot) {
        const btn = $.id('claimLeadershipBtn')
        if (btn) {
          btn.onclick = handleTx(async () => {
            return await PyramidGame.claimLeaderboardSlot()
          }, 'claimError')
        }
      } else {
        // Wire up send more ETH button
        const sendMoreEthInput = $.id('sendMoreEthInput')
        if (sendMoreEthInput) {
          sendMoreEthInput.oninput = createUpdateSendMessage({
            erc20Balance,
            userIsLeader,
            lowestLeader,
            userTokens,
            leaderContributionTotal,
            activeLeaderse,
            getProjection,
            inputId: 'sendMoreEthInput',
            messageId: 'sendMoreEthMessage'
          })
        }

        const sendMoreBtn = $.id('sendMoreEthBtn')
        if (sendMoreBtn) {
          sendMoreBtn.onclick = handleTx(async () => {
            $.id('sendMoreEthMessage').innerHTML = ''
            const amount = parseFloat($.id('sendMoreEthInput').value)
            if (!amount || amount <= 0) {
              throw new Error('Invalid amount')
            }
            return await PyramidGame.contribute(txValue(amount))
          }, 'sendMoreEthError')
        }
      }
    }

    if (pgBalance > 1e-8) {
      const btn = $.id('forceDistributeBtn')
      if (btn) {
        btn.onclick = handleTx(async () => {
          return await PyramidGame.forceDistribution()
        }, 'forceDistributeError')
      }
    }


    // Render contribution events (already fetched earlier)
    const allContributions = contributionEvents.slice().reverse() // All contributions, most recent first

    if (allContributions.length > 0) {
      const contributionRows = await Promise.all(allContributions.map(async event => {
        const prettySender = await provider.formatAddr(event.sender)
        const amount = ethVal(event.amount)
        const block = await provider.provider.getBlock(event.blockNumber)
        const timeAgoStr = timeAgo(block.timestamp * 1000)
        return `
          <a class="contribution-row" href="https://${etherscanLink}/tx/${event.txHash}" target="_blank" rel="nofollow">
            <span class="address">${prettySender}</span> sent <span class="contribution-amount"><span style="margin-right: 0.25em">Ξ</span>${amount.toFixed(4)}</span> ${timeAgoStr}
          </a>
        `
      }))

      $.id('distributions').innerHTML = `
        <h2 class="section-title">Contributions<sup style="font-size:0.75em"><a href="#docs-contributions">?</a></sup></h2>
        <h4 style="text-align: center; margin-top: 0.5em;">Total Contributions: <strong>${contributionEvents.length}</strong></h4>
        <div style="max-width: 800px; margin: 1em auto;">
          ${contributionRows.join('')}
        </div>
      `
    } else {
      $.id('distributions').innerHTML = `
        <h2 class="section-title">Contributions</h2>
        <h4 style="text-align: center; margin-top: 0.5em;">Total Contributions: <strong>0</strong></h4>
        <p>No contributions yet</p>
      `
    }

    // Recursive function to render game tree
    async function renderGameTree(gameAddress, indentLevel = 0) {
      try {
        const gameContract = await provider.contract(gameAddress, CONTRACTS.PyramidGame.abi)
        const [gameName, totalChildren] = await Promise.all([
          gameContract.name(),
          gameContract.totalChildren()
        ])

        // Check if this is the root game
        const { name: networkKey } = await provider.getNetwork()
        const rootGameAddr = ROOT_GAME_ADDRESSES[networkKey]
        const isRootGame = rootGameAddr && gameAddress.toLowerCase() === rootGameAddr.toLowerCase()
        const gameLink = isRootGame ? '/' : `?address=${gameAddress}`

        const indentPx = indentLevel * 30
        let html = `
          <div style="margin: 0.5em 0; padding-left: ${indentPx}px; text-align: left;">
            <a href="${gameLink}" style="text-decoration: underline; word-break: break-all;">
              ${gameName}
            </a>
          </div>
        `

        // Recursively render children
        const numChildren = Number(totalChildren)
        if (numChildren > 0) {
          for (let i = 0; i < numChildren; i++) {
            const childAddress = await gameContract.children(i)
            html += await renderGameTree(childAddress, indentLevel + 1)
          }
        }

        return html
      } catch (e) {
        return ''
      }
    }

    // Render related games section (children and parent)
    const totalChildren = Number(await PyramidGame.totalChildren())

    // Check if this game has a parent
    let parentGameHTML = ''
    let isChildGame = false
    try {
      const parentAddr = await PyramidGame.parent()
      if (parentAddr && parentAddr !== ethers.constants.AddressZero) {
        const parentContract = await provider.contract(parentAddr, CONTRACTS.PyramidGame.abi)
        const parentName = await parentContract.name()

        // Check if parent is the root game
        const { name: networkKey } = await provider.getNetwork()
        const rootGameAddr = ROOT_GAME_ADDRESSES[networkKey]
        const isRootGame = rootGameAddr && parentAddr.toLowerCase() === rootGameAddr.toLowerCase()
        const parentLink = isRootGame ? '/' : `?address=${parentAddr}`

        const headerHTML = isRootGame ? '' : '<h3 style="text-align: center;">Parent</h3>'

        parentGameHTML = `
          <div style="margin-bottom: 2em;">
            ${headerHTML}
            <div style="margin-bottom: 1em; text-align: left;">
              <a href="${parentLink}" style="text-decoration: underline; word-break: break-all;">
                ${parentName}
              </a>
            </div>
          </div>
        `

        // This is a child game
        isChildGame = true
      }
    } catch (e) {
      // Parent function may not exist or may return zero address
    }

    // Update top game address display if viewing a child game
    if (isChildGame) {
      const gameAddress = PyramidGame.address
      const prettyGameAddr = await provider.formatAddr(gameAddress, true)
      const topGameTitle = document.querySelector('.scanlink-style')
      if (topGameTitle) {
        topGameTitle.innerHTML = `${prettyGameAddr}<svg xmlns="http://www.w3.org/2000/svg" width="0.6em" viewBox="0 0 156 184" fill="none" style="margin-left: 0.25em; margin-top: 0em;">
          <rect x="6" y="6" width="144" height="172" stroke-width="23"/>
          <path d="M32 52H124" stroke-width="15"/>
          <path d="M32 92H124" stroke-width="15"/>
          <path d="M32 132H124" stroke-width="15"/>
        </svg>`
      }
    }

    // Render current game's children
    let childrenHTML = ''
    if (totalChildren > 0) {
      let childLinks = ''
      for (let i = 0; i < totalChildren; i++) {
        const childAddress = await PyramidGame.children(i)
        childLinks += await renderGameTree(childAddress)
      }
      childrenHTML = `
        <div>
          <h3 style="text-align: center;">Children</h3>
          <div style="margin-bottom: 1em;">
            ${childLinks}
          </div>
        </div>
      `
    }

    console.log(totalChildren, parentGameHTML)

    if (totalChildren > 0 || parentGameHTML) {
      $.id('childGames').innerHTML = parentGameHTML + childrenHTML

    } else if (parentGameHTML) {
      $.id('childGames').innerHTML = parentGameHTML

    } else {
      // No parent or children - hide the section
      $.id('childGames').innerHTML = ''
    }

    // Wire up create child game button
    const createChildBtn = $.id('createChildBtn')
    if (createChildBtn) {
      createChildBtn.onclick = handleTx(async () => {
        const amount = parseFloat($.id('createChildInput').value)
        if (!amount || amount <= 0) {
          throw new Error('Invalid amount')
        }

        // Generate child names/symbols automatically
        const parentName = await PyramidGame.name()
        const parentSymbol = await PyramidGame.symbol()
        const parentLeaderboard = await PyramidGame.leaderboard()
        const leaderboardContract = await provider.contract(parentLeaderboard, CONTRACTS.PyramidGameLeaderboard.abi)
        const parentLeaderSymbol = await leaderboardContract.symbol()

        const childIndex = Number(await PyramidGame.totalChildren()) + 1
        const childNumber = String(childIndex)

        // Check if parent has a number suffix
        const hasNumberSuffix = /\d$/.test(parentSymbol)

        let gameName, tokenSymbol, leaderSymbol

        if (hasNumberSuffix) {
          // Use dot notation for children of children
          gameName = `${parentName}.${childNumber}`
          tokenSymbol = `${parentSymbol}.${childNumber}`
          leaderSymbol = `${parentLeaderSymbol}.${childNumber}`
        } else {
          // First level children
          gameName = `${parentName} ${childNumber}`
          tokenSymbol = `${parentSymbol}${childNumber}`
          leaderSymbol = `${parentLeaderSymbol}${childNumber}`
        }

        return await PyramidGame.deployChildPyramidGame(gameName, tokenSymbol, leaderSymbol, txValue(amount))
      }, 'createChildError')
    }

    addEtherscanLinks('scanlink', 'PyramidGame', chainName)

    if (loaded) {
      resetColors()
    }

  }

  let loaded = false
  setTimeout(() => {
    loaded = true
  }, 5000)

  // Load custom game from URL parameter, then render
  provider.onConnect(async (addr) => {
    await loadCustomGame()
    renderPage(addr)
  })



  export const setColor = (c, v) => {
    const r = document.querySelector(':root')
    r.style.setProperty(c, v)
  }


  let colorList = []

  function resetColors() {
    const colors = [
     'var(--green-color)',
     'var(--black-color)',
     'var(--blue-color)',
     'var(--red-color)',
    ].sort(() => Math.random() - 0.5)




    setColor('--bg-color', colors[0])
    setColor('--font-color', colors[1])
    setColor('--accent-color', colors[2])
    setColor('--error-color', colors[3])

    if (colors[1] === 'var(--red-color)') {
      setColor('--gray-color', '#0e413c')
    } else if (colors[1] === 'var(--blue-color)') {
      setColor('--gray-color', '#27887e')
    } else if (colors[1] === 'var(--green-color)') {
      setColor('--gray-color', '#5c7471')
    } else {
      setColor('--gray-color', '#a1bebb')
    }

    if (colorList[0] === colors[0]) resetColors()
    else colorList = colors
  }


$.id('logo').onclick = resetColors

  resetColors()




// pink/orange

const pyramid = (c1, c2) => {
  console.log(c1, c2)
  return `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 487 487" fill="none" style="display: inline-block; width: 350px">
      <rect width="100%" height="100%" x="0" y="0" fill="${c2} !important" stroke-width="0"></rect>
      <path d="M465.001 435.5H244.995H20.5L242.75 50L465.001 435.5Z"  stroke-width="14" stroke="${c1} !important"/>
      <path d="M205.5 348C216 357 227.513 359.224 243.001 359.999C293 362.5 301.001 294.999 243.001 293.499C185.001 291.999 196.5 224.5 243.001 229.998C243.001 229.998 259.5 229.998 276.5 244"  stroke-width="14" stroke-linecap="square" stroke="${c1} !important"/>
      <line x1="242.5" y1="201" x2="242.5" y2="386"  stroke-width="14" stroke="${c1} !important"/>
    </svg>
`}







</script>
</html>