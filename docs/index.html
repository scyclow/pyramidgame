

<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Pyramid Game</title>
  <link rel="shortcut icon" type="image/x-icon" href="./logo.svg" id="favicon">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <meta name="description" content="">
  <meta name="keywords" content="pyramid game, pyramid, game, steviep, steve pikelny, pikelny, crypto, ethereum, eth, bitcoin, scam, pyramid scheme, scheme">

  <meta name="twitter:image" content="h">
  <meta name="twitter:image:alt" content="">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:creator" content="@steviepxyz">
  <meta name="twitter:site" content="@steviepxyz">
  <meta property="twitter:description" content="">

  <meta name="og:image" property="og:image" content="">
  <meta name="og:image:alt" content="">
  <meta property="og:type" content="website">
  <meta property="og:url" content="">
  <meta property="og:title" content="">
  <meta property="og:site_name" content="">
  <meta property="og:description" content="">


  <link rel="stylesheet" type="text/css" href="./styles.css">

  <style type="text/css">

    h1 {
      font-size: min(5em, 13vw);
      font-weight: 500;
    }

    h1, h2, h3 {
      text-align: center;
    }

    .slowBlink {
      animation: Blink 3s steps(2, start) infinite;
    }

    #logo {
      width: 500px;
      max-width: 81vw;
    }

    button {
      background: var(--gray-color);
      color: var(--font-color);
      border: 0.15em solid var(--font-color);
      padding: 0.5em 1em;
      font-size: 2em;
      font-weight: 500;
      letter-spacing: 0.1em;
    }

    button:hover {
      color: var(--bg-color);
      background: var(--accent-color);
      border-color: var(--accent-color);
    }

    button:active {
      color: var(--font-color);
      border-color: var(--font-color);
      background: var(--bg-color);
    }

    .connectButton:hover {
      border-color: var(--font-color);
    }

    .center-v {
      display: flex;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .center {
      display: flex;
      justify-content: center;
    }

    table {
      border: 2px solid;
      border-spacing: 0;
    }

    td, th {
      border: 1px solid;
      padding: 0.5em;
    }

    th {
      font-weight: 600;
    }

    section {
      margin: 2.5em auto;
      padding: 0 0.75em;
    }

    input {
      border: 3px solid var(--font-color);
      text-align: center;
      padding: 0.25em 0;
      font-size: 1.25em;
      background: var(--input-color);
    }

    input:active, input:focus, input:hover {
      outline: none;
      border-color: var(--accent-color);
    }

    input + .small-button {
      border-left: 0;
    }

    .small-button {
      font-size: 1.25em;
    }

    .tiny-button {
      font-size: 1em;
      margin-top: 0.25em;
    }
    .tiny-input {
      font-size: 1em;
      padding: 0.25em;
    }

    sup a {
      display: inline-block;
      border: 1px solid;
      text-decoration: none;
      color: var(--accent-color);
      padding: 0 0.25em;
      transform: translateY(-0.25em);
      margin-left: 0.25em;
      font-size: 0.75em;
    }

    sup a:hover {
      background: var(--accent-color);
      color: var(--accent-color);
      border-color: var(--accent-color);

      text-decoration: none;
    }

    a {
      text-decoration: none;
      color: var(--font-color);
    }

    a:hover {
      text-decoration: underline;
    }

    .scanlink {
      border-bottom: 0.1em solid rgba(0, 0, 0, 0);
      font-size: 1.75em;
    }

    .scanlink:hover {
      text-decoration: none;
      border-bottom: 0.1em solid;
    }


    .largeText {
      font-size: 6em;
    }
    @media (max-width:  640px) {
      .scanlink {
        font-size: 1.25em;
      }

    }

    @media (max-width:  550px) {
      .largeText {
        font-size: 3em;
      }

    }

    @media (max-width: 450px) {
      .scanlink {
        font-size: 0.9em;
      }
    }

    .contribution-row {
      border: 2px solid var(--font-color);
      padding: 1em;
      margin-bottom: 0.5em;
      line-height: 1.5;
      display: block;
      text-decoration: none;
      color: var(--font-color);
    }

    .contribution-row:hover {
      background: var(--font-color);
      color: var(--bg-color);
    }

    .contribution-row:hover .address {
      color: var(--bg-color);
    }

    .contribution-amount {
      font-weight: 600;
    }

    /* Grid Leaderboard Styles */
    .leaderboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 0em;
      max-width: 1200px;
      margin: 2em auto;
      padding: 0 1em;
    }

    @media (max-width: 1110px) {
      .leaderboard-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    @media (max-width: 740px) {
      .leaderboard-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 580px) {
      .leaderboard-grid {
        grid-template-columns: 1fr;
      }
    }

    .leader-card {
      border: 0 solid var(--font-color);
      border-left-width: 6px;
      border-bottom-width: 6px;
      padding: 1em;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.75em;
      /*background: var(--font-color);*/
      /*color: var(--bg-color);*/
    }
    .leader-card .address {
      /*color: var(--bg-color);*/
    }

    /* 4 columns - rightmost column (every 4th) gets right border */
    .leader-card:nth-child(4n) {
      border-right-width: 6px;
    }
    /* 4 columns - top row (first 4) gets top border */
    .leader-card:nth-child(-n+4) {
      border-top-width: 6px;
    }

    @media (max-width: 1110px) {
      /* 3 columns - reset 4-column rules */
      .leader-card:nth-child(4n) {
        border-right-width: 0;
      }
      .leader-card:nth-child(-n+4) {
        border-top-width: 0;
      }
      /* 3 columns - rightmost column (every 3rd) gets right border */
      .leader-card:nth-child(3n) {
        border-right-width: 6px;
      }
      /* 3 columns - top row (first 3) gets top border */
      .leader-card:nth-child(-n+3) {
        border-top-width: 6px;
      }
    }

    @media (max-width: 740px) {
      /* 2 columns - reset 3-column rules */
      .leader-card:nth-child(3n) {
        border-right-width: 0;
      }
      .leader-card:nth-child(-n+3) {
        border-top-width: 0;
      }
      /* 2 columns - rightmost column (every 2nd) gets right border */
      .leader-card:nth-child(2n) {
        border-right-width: 6px;
      }
      /* 2 columns - top row (first 2) gets top border */
      .leader-card:nth-child(-n+2) {
        border-top-width: 6px;
      }
    }

    @media (max-width: 580px) {
      /* 1 column - reset 2-column rules and set all items to get right border */
      .leader-card:nth-child(n) {
        border-right-width: 6px;
        border-top-width: 0;
      }
      /* 1 column - only first item gets top border */
      .leader-card:nth-child(1) {
        border-top-width: 6px;
      }
    }

    .leader-card img,
    .leader-card leader-svg {
      width: 100%;
      max-width: 200px;
      height: auto;
      display: block;
    }

    .leader-info {
      width: 100%;
      text-align: center;
      font-size: 0.9em;
    }

    .leader-info > div {
      margin: 0.25em 0;
    }

    .section-box {
      border: 3px solid var(--font-color);
      padding: 1.5em;
      margin: 2em auto;
      max-width: 800px;
    }

    .token-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 1em;
      margin-top: 1em;
    }

    .token-item {
      border: 2px solid var(--font-color);
      padding: 0.5em;
      text-align: center;
    }

    .token-item img,
    .token-item leader-svg {
      width: 100%;
      max-width: 120px;
      display: block;
    }

    .erc20-controls {
      display: flex;
      flex-direction: column;
      gap: 1em;
      margin-top: 1em;
    }

    .control-row {
      display: flex;
      gap: 0.5em;
      align-items: center;
      flex-wrap: wrap;
    }

    .error-message {
      color: var(--red-color);
      margin-top: 0.5em;
      min-height: 1.5em;
      font-size: 0.9em;
    }

    .blinkSlow {
      animation: Blink 2s steps(2, start) infinite;
    }


  </style>


  <script src="./utils.js"></script>
  <!-- <script type="module" src="./modal.js"></script> -->
  <script type="module" src="./connectWallet.js"></script>




</head>
<body>
  <div class="center-v" style="height: 80vh;">

    <svg id="logo" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 487 487" fill="none">
      <path d="M465.001 435.5H244.995H20.5L242.75 50L465.001 435.5Z"  stroke-width="14"/>
      <path d="M205.5 348C216 357 227.513 359.224 243.001 359.999C293 362.5 301.001 294.999 243.001 293.499C185.001 291.999 196.5 224.5 243.001 229.998C243.001 229.998 259.5 229.998 276.5 244"  stroke-width="14" stroke-linecap="square"/>
      <line x1="242.5" y1="201" x2="242.5" y2="386"  stroke-width="14"/>
    </svg>

    <h1>Pyramid Game</h1>
  </div>



  <connect-wallet>
    <div slot="connected">

      <section class="center-v">
        <div class="center">
          <input placeholder="0.01 Ξ" type="number" style="width:10.1em">  <button class="small-button">Send</button>
        </div>
      </section>

    </div>

    <div slot="notConnected">
      <div class="center" style="margin-top: 1em">
        <connect-button>
          <button class="connectButton" slot="button">CONNECT</button>
        </connect-button>
      </div>
    </div>
  </connect-wallet>




  </section>


  <section>
    <connect-wallet>
      <div slot="notConnected">
        <h1 class="slowBlink largeText" style="margin-bottom: 0.25em">$</h1>
      </div>
    </connect-wallet>

    <svg xmlns="http://www.w3.org/2000/svg" width="100%"  viewBox="0 0 1095 225" fill="none">
      <path d="M547 225L590.301 150L503.699 150L547 225ZM539.5 3.27835e-07L539.5 157.5L554.5 157.5L554.5 -3.27835e-07L539.5 3.27835e-07Z" fill="var(--font-color)"/>
    </svg>


    <h2 style="display: flex; align-items: center; justify-content: center; margin: 1em 0">
      <a class="scanlink">
        pyramidgame.eth<svg xmlns="http://www.w3.org/2000/svg" width="0.6em" viewBox="0 0 156 184" fill="none" style="margin-left: 0.25em; margin-top: 0em;">
          <rect x="6" y="6" width="144" height="172" stroke-width="23"/>
          <path d="M32 52H124" stroke-width="15"/>
          <path d="M32 92H124" stroke-width="15"/>
          <path d="M32 131H124" stroke-width="15"/>
        </svg>
      </a>
    </h2>


    <svg xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 1168 702" fill="none">
      <path d="M284 627L327.301 552L240.699 552L284 627ZM276.5 179L276.5 559.5L291.5 559.5L291.5 179L276.5 179Z" fill="var(--font-color)"/>
      <path d="M404 590L447.301 515L360.699 515L404 590ZM396.5 179L396.5 522.5L411.5 522.5L411.5 179L396.5 179Z" fill="var(--font-color)"/>
      <path d="M525 553L568.301 478L481.699 478L525 553ZM517.5 179L517.5 485.5L532.5 485.5L532.5 179L517.5 179Z" fill="var(--font-color)"/>
      <path d="M164 665L207.301 590L120.699 590L164 665ZM156.5 179L156.5 597.5L171.5 597.5L171.5 179L156.5 179Z" fill="var(--font-color)"/>
      <path d="M44 702L87.3013 627H0.69873L44 702ZM36.5 179L36.5 634.5H51.5L51.5 179H36.5Z" fill="var(--font-color)"/>
      <path d="M885 441L928.301 366L841.699 366L885 441ZM877.5 179L877.5 373.5L892.5 373.5L892.5 179L877.5 179Z" fill="var(--font-color)"/>
      <path d="M1004 403L1047.3 328L960.699 328L1004 403ZM996.5 179L996.5 335.5L1011.5 335.5L1011.5 179L996.5 179Z" fill="var(--font-color)"/>
      <path d="M1124 366L1167.3 291L1080.7 291L1124 366ZM1116.5 179L1116.5 298.5L1131.5 298.5L1131.5 179L1116.5 179Z" fill="var(--font-color)"/>
      <path d="M764 478L807.301 403L720.699 403L764 478ZM756.5 179L756.5 410.5L771.5 410.5L771.5 179L756.5 179Z" fill="var(--font-color)"/>
      <path d="M645 515L688.301 440L601.699 440L645 515ZM637.5 179L637.5 447.5L652.5 447.5L652.5 179L637.5 179Z" fill="var(--font-color)"/>
      <line x1="36.5" y1="181.5" x2="1131.5" y2="181.5"  stroke-width="15"/>
      <line x1="583.5" y1="-3.27835e-07" x2="583.5" y2="189"  stroke-width="15"/>
    </svg>

    <div class="center-v">
      <h2 style="font-size: 2.675em; margin-bottom: 0.25em;">Leaders <sup style="margin-left: -1em; font-size: 0.5em;"><a href="#faq">?</a></sup></h2>

      <connect-wallet>
        <div slot="connected">
          <div id="leaderboardStats" style="text-align: center; margin: 1.5em auto; font-size: 1.2em;"></div>
          <div id="leaderboard" class="leaderboard-grid"></div>
        </div>

        <div slot="notConnected">
          <div class="center" style="margin-top: 1em; border: 3px solid; padding: 1.5em">
            <connect-button>
              <button class="connectButton" slot="button" style="font-size: 1.5em">Connect to view<br> Leaderboard</button>
              <div slot="loading" class="slowBlink" style="font-size: 1.5em">Connecting...</div>
            </connect-button>
          </div>
        </div>
      </connect-wallet>
    </div>
  </section>

  <section>
    <connect-wallet>
      <div slot="connected">
        <div id="userLeaderSection"></div>
      </div>
    </connect-wallet>
  </section>

  <section>
    <connect-wallet>
      <div slot="connected">
        <div id="erc20Section"></div>
      </div>
    </connect-wallet>
  </section>

  <section>
    <div style="margin: 1em">
      <svg xmlns="http://www.w3.org/2000/svg" width="100%"  viewBox="0 0 1095 225" fill="none">
        <path d="M547 225L590.301 150L503.699 150L547 225ZM539.5 3.27835e-07L539.5 157.5L554.5 157.5L554.5 -3.27835e-07L539.5 3.27835e-07Z" fill="var(--font-color)"/>
      </svg>
    </div>

    <h1 class="slowBlink">$</h1>
  </section>

  <section>
    <div class="center-v">
      <connect-wallet>
        <div slot="connected">
          <div id="yourContributions" style="margin-top: 0em; border: 1.35em double; padding: 0.5em;"></div>
        </div>
      </connect-wallet>
    </div>
  </section>


  <section class="center-v">
  </section>


  <section class="center-v" id="faq">
    <h2>???</h2>
    <p>All ETH sent to the Pyramid Game is split between the Leaders.</p>
    <p>Leaders are determined by </p>
  </section>

  <section class="center-v" id="distributions">
    <h2>Latest Distributions</h2>
  </section>



  <footer style="margin: 4em auto;"><a href="https://steviep.xyz" target="_blank" style="text-decoration: underline;">steviep.xyz</a> 2025</footer>



<!--     <div class="block" style="background: var(--black-color); color: var(--red-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--gray-color); color: var(--green-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--white-color); color: var(--red-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--green-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--cyan-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--blue-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
    <div class="block" style="background: var(--magenta-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>

    <div class="block" style="background: var(--red-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>


    <div class="block" style="background: var(--orange-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>

    <div class="block" style="background: var(--yellow-color); color: var(--black-color);">
      dsfasdfsadfasdfdasd
    </div>
 -->


</body>



<script type="module">
  import {provider, etherscanAddr, addEtherscanLinks, ethVal} from './eth.js'
  import {CONTRACTS} from './contracts.js'
  import {$} from './$.js'

  // Define leader-svg web component with isolated styles
  class LeaderSVG extends HTMLElement {
    constructor() {
      super()
      this.attachShadow({ mode: 'open' })
    }

    connectedCallback() {
      const svg = this.getAttribute('svg')
      if (svg) {
        this.shadowRoot.innerHTML = `
          <style>
            :host {
              display: block;
              width: 100%;
              height: auto;
            }
            svg {
              width: 100%;
              height: auto;
              display: block;
            }
          </style>
          ${svg}
        `
      }
    }
  }
  customElements.define('leader-svg', LeaderSVG)

  provider.setContractInfo(CONTRACTS)

  addEtherscanLinks('scanlink', 'PyramidGame')

  provider.onConnect(async (addr) => {
    const { PyramidGame } = await provider.getContracts()
    const { name: chainName, etherscanLink } = await provider.getNetwork()

    // Get PyramidGameLeaders contract
    const leadersAddr = await PyramidGame.leaders()
    const PyramidGameLeaders = await provider.contract(leadersAddr, CONTRACTS.PyramidGameLeaders.abi)

    // Get total supply of leader tokens
    const totalSupply = Number(await PyramidGameLeaders.totalSupply())
    const contributionTotal = ethVal(await PyramidGameLeaders.contributionTotal())

    // Helper to extract SVG markup from tokenURI
    const utf8Clean = raw => raw.replace(/data.*utf8,/, '')
    const b64Clean = raw => raw.replace(/data.*,/, '')

    const extractSVG = rawURI => {
      try {
        const imageDataURI = JSON.parse(utf8Clean(rawURI)).image
        const svgMarkup = atob(b64Clean(imageDataURI))
        return svgMarkup
      } catch (e) {
        console.error('Error extracting SVG:', e)
        return ''
      }
    }

    // Fetch all leader data
    const leaders = await Promise.all(times(totalSupply, async i => {
      const owner = await PyramidGameLeaders.ownerOf(i)
      const prettyAddr = await provider.formatAddr(owner)
      const contribution = ethVal(await PyramidGameLeaders.contributions(i))
      const tokenURI = await PyramidGameLeaders.tokenURI(i)
      const svg = extractSVG(tokenURI)
      const percentage = (contribution / contributionTotal) * 100

      return {
        tokenId: i,
        owner,
        prettyAddr,
        contribution,
        svg,
        percentage
      }
    }))

    // Sort by contribution (highest first)
    const sortedLeaders = leaders.sort((a, b) => b.contribution - a.contribution)
    const lowestLeader = sortedLeaders[sortedLeaders.length - 1]

    // Calculate total contributions
    const tokensPerEth = Number(await PyramidGame.TOKENS_PER_ETH())
    const pyramidTotalSupply = ethVal(await PyramidGame.totalSupply())
    const pyramidSupplyInEth = pyramidTotalSupply / tokensPerEth
    const totalContributed = contributionTotal + pyramidSupplyInEth

    // Render stats
    $.id('leaderboardStats').innerHTML = `
      <div style="display: flex; justify-content: center; gap: 2em; flex-wrap: wrap;">
        <div><strong>Leaders:</strong> ${totalSupply}</div>
        <div><strong>Leader Contributions:</strong> <span style="margin-right: 0.25em">Ξ</span>${contributionTotal.toFixed(4)}</div>
        <div><strong>Total Contributed:</strong> <span style="margin-right: 0.25em">Ξ</span>${totalContributed.toFixed(4)}</div>
      </div>
    `

    // Render leaderboard grid
    $.id('leaderboard').innerHTML = sortedLeaders.map(l => {
      const escapedSVG = l.svg.replace(/"/g, '&quot;')
      return `
        <div class="leader-card">
          <leader-svg svg="${escapedSVG}"></leader-svg>
          <div class="leader-info">
            <div><strong>#${l.tokenId}</strong></div>
            <div>${etherscanAddr(etherscanLink, l.owner, l.prettyAddr)}</div>
            <div><span style="margin-right: 0.25em">Ξ</span>${l.contribution.toFixed(4)}</div>
            <div><strong>${l.percentage.toFixed(2)}%</strong></div>
          </div>
        </div>
      `
    }).join('')

    // Get user's tokens
    const userTokens = leaders.filter(l => l.owner.toLowerCase() === addr.toLowerCase())

    // Get user's ERC20 balance
    const erc20Balance = ethVal(await PyramidGame.balanceOf(addr))
    const erc20BalanceInEth = erc20Balance / tokensPerEth

    // Render user leader section
    if (userTokens.length > 0) {
      $.id('userLeaderSection').innerHTML = `
        <div class="section-box">
          <h2>Your Leader Tokens</h2>
          <div class="token-grid">
            ${userTokens.map(t => {
              const escapedSVG = t.svg.replace(/"/g, '&quot;')
              return `
                <div class="token-item">
                  <leader-svg svg="${escapedSVG}"></leader-svg>
                  <div><strong>#${t.tokenId}</strong></div>
                  <div><span style="margin-right: 0.25em">Ξ</span>${t.contribution.toFixed(4)}</div>
                </div>
              `
            }).join('')}
          </div>
          ${erc20Balance > 0 ? `
            <div style="margin-top: 2em;">
              <h3>Add to Leader Contribution</h3>
              <p>You have ${erc20BalanceInEth.toFixed(4)} Ξ worth of $PYRAMID tokens</p>
              <div class="control-row">
                <input id="addContribTokenId" class="tiny-input" placeholder="Token ID" style="width: 8em;">
                <input id="addContribAmount" class="tiny-input" placeholder="Amount (Ξ)" style="width: 8em;">
                <button id="addContribBtn" class="tiny-button">Add to Balance</button>
              </div>
              <div id="addContribError" class="error-message"></div>
            </div>
          ` : ''}
        </div>
      `

      if (erc20Balance > 0) {
        $.id('addContribBtn').onclick = async () => {
          $.id('addContribError').innerHTML = 'Pending...'
          try {
            const tokenId = Number($.id('addContribTokenId').value)
            const amount = parseFloat($.id('addContribAmount').value)
            const tokenAmount = Math.floor(amount * tokensPerEth)

            const tx = await PyramidGame.addToLeaderContributionBalance(tokenId, tokenAmount)
            $.id('addContribError').innerHTML = `<span class="blinkSlow">TX Pending.</span> <a href="https://${etherscanLink}/tx/${tx.hash}" target="_blank" rel="nofollow">View on etherscan</a>`
            await tx.wait(1)
            $.id('addContribError').innerHTML = 'Success'
            setTimeout(() => {
              $.id('addContribError').innerHTML = ''
              location.reload()
            }, 2000)
          } catch (e) {
            $.id('addContribError').innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
            console.error(e)
          }
        }
      }
    }

    // Render ERC20 section
    if (erc20Balance > 0) {
      const canClaimLeadership = erc20BalanceInEth > lowestLeader.contribution

      $.id('erc20Section').innerHTML = `
        <div class="section-box">
          <h2>$PYRAMID Tokens</h2>
          <p style="font-size: 1.5em; margin: 0.5em 0;"><strong>${erc20BalanceInEth.toFixed(4)} Ξ</strong> worth of $PYRAMID</p>

          ${canClaimLeadership ? `
            <div style="margin-top: 1.5em; padding: 1em; border: 2px solid var(--accent-color);">
              <h3>Claim Leadership!</h3>
              <p>You have enough $PYRAMID to claim a leader spot!</p>
              <button id="claimLeadershipBtn" class="tiny-button">Claim Leadership</button>
              <div id="claimError" class="error-message"></div>
            </div>
          ` : ''}

          <div style="margin-top: 1.5em;">
            <h3>Transfer $PYRAMID</h3>
            <div class="control-row">
              <input id="transferTo" class="tiny-input" placeholder="Recipient Address" style="width: 20em; max-width: 90vw;">
              <input id="transferAmount" class="tiny-input" placeholder="Amount (Ξ)" style="width: 8em;">
              <button id="transferBtn" class="tiny-button">Transfer</button>
            </div>
            <div id="transferError" class="error-message"></div>
          </div>

          <div style="margin-top: 1.5em;">
            <h3>Approve $PYRAMID</h3>
            <div class="control-row">
              <input id="approveSpender" class="tiny-input" placeholder="Spender Address" style="width: 20em; max-width: 90vw;">
              <input id="approveAmount" class="tiny-input" placeholder="Amount (Ξ)" style="width: 8em;">
              <button id="approveBtn" class="tiny-button">Approve</button>
            </div>
            <div id="approveError" class="error-message"></div>
          </div>
        </div>
      `

      if (canClaimLeadership) {
        $.id('claimLeadershipBtn').onclick = async () => {
          $.id('claimError').innerHTML = 'Pending...'
          try {
            const tx = await PyramidGame.claimLeadership()
            $.id('claimError').innerHTML = `<span class="blinkSlow">TX Pending.</span> <a href="https://${etherscanLink}/tx/${tx.hash}" target="_blank" rel="nofollow">View on etherscan</a>`
            await tx.wait(1)
            $.id('claimError').innerHTML = 'Success! Reloading...'
            setTimeout(() => location.reload(), 2000)
          } catch (e) {
            $.id('claimError').innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
            console.error(e)
          }
        }
      }

      $.id('transferBtn').onclick = async () => {
        $.id('transferError').innerHTML = 'Pending...'
        try {
          const to = $.id('transferTo').value
          const amount = parseFloat($.id('transferAmount').value)
          const tokenAmount = Math.floor(amount * tokensPerEth)

          const tx = await PyramidGame.transfer(to, tokenAmount)
          $.id('transferError').innerHTML = `<span class="blinkSlow">TX Pending.</span> <a href="https://${etherscanLink}/tx/${tx.hash}" target="_blank" rel="nofollow">View on etherscan</a>`
          await tx.wait(1)
          $.id('transferError').innerHTML = 'Success'
          setTimeout(() => {
            $.id('transferError').innerHTML = ''
            location.reload()
          }, 2000)
        } catch (e) {
          $.id('transferError').innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
          console.error(e)
        }
      }

      $.id('approveBtn').onclick = async () => {
        $.id('approveError').innerHTML = 'Pending...'
        try {
          const spender = $.id('approveSpender').value
          const amount = parseFloat($.id('approveAmount').value)
          const tokenAmount = Math.floor(amount * tokensPerEth)

          const tx = await PyramidGame.approve(spender, tokenAmount)
          $.id('approveError').innerHTML = `<span class="blinkSlow">TX Pending.</span> <a href="https://${etherscanLink}/tx/${tx.hash}" target="_blank" rel="nofollow">View on etherscan</a>`
          await tx.wait(1)
          $.id('approveError').innerHTML = 'Success'
          setTimeout(() => $.id('approveError').innerHTML = '', 4000)
        } catch (e) {
          $.id('approveError').innerHTML = e?.data?.message || e?.error?.message || e?.message || 'Something went wrong'
          console.error(e)
        }
      }
    }

    // Fetch and render contribution events
    const contributionEvents = await provider.contractEvents(PyramidGame, 'Contribution', [])
    const recentContributions = contributionEvents.slice(-20) // Last 20, oldest first

    const timeAgo = timestamp => {
      const now = Date.now()
      const diff = Math.floor((now - timestamp) / 1000) // difference in seconds

      if (diff < 60) return `${diff} second${diff === 1 ? '' : 's'} ago`
      if (diff < 3600) {
        const mins = Math.floor(diff / 60)
        return `${mins} minute${mins === 1 ? '' : 's'} ago`
      }
      if (diff < 86400) {
        const hours = Math.floor(diff / 3600)
        return `${hours} hour${hours === 1 ? '' : 's'} ago`
      }
      if (diff < 31536000) {
        const days = Math.floor(diff / 86400)
        return `${days} day${days === 1 ? '' : 's'} ago`
      }
      const years = Math.floor(diff / 31536000)
      return `${years} year${years === 1 ? '' : 's'} ago`
    }

    if (recentContributions.length > 0) {
      const contributionRows = await Promise.all(recentContributions.map(async event => {
        const prettySender = await provider.formatAddr(event.sender)
        const amount = ethVal(event.amount)
        const block = await provider.provider.getBlock(event.blockNumber)
        const timeAgoStr = timeAgo(block.timestamp * 1000)
        return `
          <a class="contribution-row" href="https://${etherscanLink}/tx/${event.txHash}" target="_blank" rel="nofollow">
            <span class="address">${prettySender}</span> sent <span class="contribution-amount"><span style="margin-right: 0.25em">Ξ</span>${amount.toFixed(4)}</span> ${timeAgoStr}
          </a>
        `
      }))

      $.id('distributions').innerHTML = `
        <h2>Latest Contributions</h2>
        <div style="max-width: 800px; margin: 1em auto;">
          ${contributionRows.join('')}
        </div>
      `
    } else {
      $.id('distributions').innerHTML = `
        <h2>Latest Contributions</h2>
        <p>No contributions yet</p>
      `
    }

    addEtherscanLinks('scanlink', 'PyramidGame', chainName)
  })



export const setColor = (c, v) => {
  const r = document.querySelector(':root')
  r.style.setProperty(c, v)
}

const colors = [
 'var(--green-color)',
 'var(--black-color)',
 'var(--blue-color)',
 'var(--red-color)',
]//.sort(() => Math.random() - 0.5)


setColor('--bg-color', colors[0])
setColor('--font-color', colors[1])
setColor('--accent-color', colors[2])


// pink/orange

const pyramid = (c1, c2) => {
  console.log(c1, c2)
  return `
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 487 487" fill="none" style="display: inline-block; width: 350px">
      <rect width="100%" height="100%" x="0" y="0" fill="${c2} !important" stroke-width="0"></rect>
      <path d="M465.001 435.5H244.995H20.5L242.75 50L465.001 435.5Z"  stroke-width="14" stroke="${c1} !important"/>
      <path d="M205.5 348C216 357 227.513 359.224 243.001 359.999C293 362.5 301.001 294.999 243.001 293.499C185.001 291.999 196.5 224.5 243.001 229.998C243.001 229.998 259.5 229.998 276.5 244"  stroke-width="14" stroke-linecap="square" stroke="${c1} !important"/>
      <line x1="242.5" y1="201" x2="242.5" y2="386"  stroke-width="14" stroke="${c1} !important"/>
    </svg>
`}







</script>
</html>